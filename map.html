<!DOCTYPE html>
<html class="dark" lang="th">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Map Navigator Pro V3.2 (Smart Calculation)</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet"/>
    
    <script src="https://api.longdo.com/map/?key=bfe0b1b41b9bd6f49ab8eae336fe80dc"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: "#4F46E5", 50: "#EEF2FF", 500: "#6366F1", 600: "#4F46E5", 700: "#4338CA" },
                    },
                    fontFamily: {
                        sans: ["Kanit", "sans-serif"],
                        display: ["Outfit", "Kanit", "sans-serif"],
                    },
                    boxShadow: {
                        'floating': '0 8px 30px -4px rgba(0, 0, 0, 0.15)',
                    },
                    zIndex: {
                        'modal': 9999,
                    }
                },
            },
        };
    </script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 0; }
        
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; will-change: auto; }
        .smooth-animation { transform: translate3d(0, 0, 0); backface-visibility: hidden; perspective: 1000px; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #334155; }

        .gps-marker-icon {
            width: 22px; height: 22px;
            background-color: #3b82f6; border: 3px solid white; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative; z-index: 100;
            animation: pulse-marker 2s infinite;
        }

        @keyframes pulse-marker {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #6366F1;
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .traffic-light {
            display: inline-block; width: 12px; height: 12px; border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .traffic-light.green { background-color: #10b981; }
        .traffic-light.yellow { background-color: #f59e0b; }
        .traffic-light.red { background-color: #ef4444; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .icon-svg { transition: color 0.3s ease, fill 0.3s ease; }

        .gps-loading {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px;
            background: #dbeafe; border-radius: 8px; font-size: 12px; color: #0369a1;
        }
        .dark .gps-loading { background: #0c4a6e; color: #0ea5e9; }

        .route-option-btn { transition: all 0.3s ease; will-change: background-color, transform; }
        .route-option-btn.active { transform: scale(1.02); }

        .turn-card { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .live-nav-hud { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

        .recalc-indicator {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 8px; border-radius: 4px;
            background: #dbeafe; color: #0369a1; font-size: 11px; font-weight: 600;
        }
        .dark .recalc-indicator { background: #0c4a6e; color: #0ea5e9; }

        .recalc-badge-pulse {
            animation: badgePulse 1s infinite;
        }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        @media (max-width: 1023px) {
            .desktop-sidebar { display: none; }
            .mobile-panel { display: flex; }
            .map-container { height: 100dvh; width: 100vw; position: absolute; top: 0; left: 0; }
            .ldmap_ui_layer_selector { top: 90px !important; right: 12px !important; }
        }
        
        @media (min-width: 1024px) {
            .desktop-sidebar { display: flex; }
            .mobile-panel { display: none; }
            .map-container { height: 100%; border-radius: 1.5rem; overflow: hidden; position: relative; }
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300 h-[100dvh] w-full flex flex-col">

    <!-- Location Modal -->
    <div id="location-modal" class="fixed inset-0 z-modal bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-rounded text-3xl">location_off</span>
            </div>
            <h2 id="modal-title" class="text-xl font-bold mb-2">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">
                ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
            </p>
            <button onclick="requestLocationPermission()" class="w-full py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-primary-500/30">
                ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-sm px-4" role="region" aria-live="polite"></div>

    <!-- GPS Status -->
    <div id="gps-status" class="fixed bottom-4 right-4 z-50 gps-loading hidden">
        <div class="loader" style="width: 12px; height: 12px;"></div>
        <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</span>
    </div>

    <!-- Desktop Header -->
    <header class="hidden lg:flex h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 items-center justify-between px-6 z-20 shadow-sm flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-primary-600 text-white p-2 rounded-xl">
                <span class="material-symbols-rounded icon-svg">explore</span>
            </div>
            <h1 class="font-bold text-lg">Map Navigator <span class="text-primary-600 font-normal text-sm ml-2">Pro V3.2</span></h1>
            <span class="text-xs text-slate-400 dark:text-slate-500 ml-2">(Smart Calculation üáπüá≠)</span>
        </div>
        <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
            <span class="material-symbols-rounded theme-icon icon-svg">dark_mode</span>
        </button>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar w-[420px] flex-col gap-4 p-4 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 z-10 shadow-xl overflow-hidden">
            
            <a href="dashboard.html" class="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-primary-600 mb-2 px-1">
                <span class="material-symbols-rounded text-lg icon-svg">arrow_back</span>
                <span class="text-sm font-medium">‡∏Å‡∏•‡∏±‡∏ö Dashboard</span>
            </a>

            <!-- Tabs -->
            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl mb-2 flex-shrink-0" role="tablist">
                <button onclick="switchTab('search')" id="d-tab-search" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 bg-white dark:bg-slate-700 shadow text-primary-600 dark:text-primary-400" role="tab" aria-selected="true">
                    <span class="material-symbols-rounded icon-svg">search</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button onclick="switchTab('route')" id="d-tab-route" class="flex-1 py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-700" role="tab" aria-selected="false">
                    <span class="material-symbols-rounded icon-svg">directions</span> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto custom-scroll relative pr-1">
                
                <!-- Search Panel -->
                <div id="d-panel-search" role="tabpanel" class="space-y-4">
                    <div class="relative">
                        <input type="text" id="d-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="w-full pl-11 pr-10 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none transition-all shadow-sm" oninput="handleTyping('search', this.value)">
                        <span class="material-symbols-rounded absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 icon-svg">search</span>
                        <div id="d-search-loading" class="hidden absolute right-3.5 top-1/2 -translate-y-1/2"><div class="loader"></div></div>
                        <div id="d-search-results" class="hidden absolute top-full left-0 w-full mt-2 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 z-50 overflow-hidden max-h-[300px] overflow-y-auto" role="listbox"></div>
                    </div>
                </div>

                <!-- Route Panel -->
                <div id="d-panel-route" role="tabpanel" class="hidden space-y-4">
                    
                    <!-- Start & End -->
                    <div class="space-y-2 relative">
                        <div class="absolute left-[23px] top-[40px] w-[2px] h-[75px] bg-slate-300 dark:bg-slate-600"></div>
                        
                        <div class="relative z-10">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-[3px] border-blue-500 bg-white dark:bg-slate-900"></div>
                            <input type="text" id="d-start-input" placeholder="‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" class="w-full pl-10 pr-12 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" oninput="handleTyping('start', this.value)">
                            <button onclick="useCurrentLocation('start')" class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg text-blue-500 dark:text-blue-400 transition-colors">
                                <span class="material-symbols-rounded text-xl icon-svg">my_location</span>
                            </button>
                            <div id="d-suggest-start" class="hidden absolute top-full left-0 w-full bg-white dark:bg-slate-800 shadow-xl rounded-xl z-20 mt-1 overflow-hidden border border-slate-200 dark:border-slate-700" role="listbox"></div>
                        </div>

                        <div class="relative z-10">
                            <span class="material-symbols-rounded absolute left-2 top-1/2 -translate-y-1/2 text-red-500 dark:text-red-400 icon-svg">location_on</span>
                            <input type="text" id="d-end-input" placeholder="‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" class="w-full pl-10 pr-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-500" oninput="handleTyping('end', this.value)">
                            <div id="d-suggest-end" class="hidden absolute top-full left-0 w-full bg-white dark:bg-slate-800 shadow-xl rounded-xl z-20 mt-1 overflow-hidden border border-slate-200 dark:border-slate-700" role="listbox"></div>
                        </div>
                    </div>

                    <!-- Route Options -->
                    <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-3 border border-slate-200 dark:border-slate-700">
                        <div class="text-xs font-semibold text-slate-600 dark:text-slate-300 mb-2">üõ£Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
                        <div class="grid grid-cols-3 gap-2" role="radiogroup">
                            <button onclick="setRouteOption('fastest')" id="route-fastest" class="route-option-btn active p-2 rounded-lg border-2 border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 flex flex-col items-center gap-1" role="radio" aria-checked="true">
                                <span class="material-symbols-rounded text-lg icon-svg">speed</span>
                                <span class="text-[10px] font-bold">‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î</span>
                            </button>
                            <button onclick="setRouteOption('eco')" id="route-eco" class="route-option-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 flex flex-col items-center gap-1" role="radio" aria-checked="false">
                                <span class="material-symbols-rounded text-lg icon-svg">eco</span>
                                <span class="text-[10px] font-bold">‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î</span>
                            </button>
                            <button onclick="setRouteOption('safe')" id="route-safe" class="route-option-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 flex flex-col items-center gap-1" role="radio" aria-checked="false">
                                <span class="material-symbols-rounded text-lg icon-svg">verified_user</span>
                                <span class="text-[10px] font-bold">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span>
                            </button>
                        </div>
                    </div>

                    <!-- Transport Mode -->
                    <div class="grid grid-cols-3 gap-2" role="radiogroup">
                        <button onclick="setMode('drive')" id="mode-drive" class="mode-btn active p-3 rounded-xl border border-primary-600 bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 flex flex-col items-center gap-1" role="radio" aria-checked="true">
                            <span class="material-symbols-rounded icon-svg">directions_car</span>
                            <span class="text-xs font-medium">‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</span>
                        </button>
                        <button onclick="setMode('bike')" id="mode-bike" class="mode-btn p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 flex flex-col items-center gap-1" role="radio" aria-checked="false">
                            <span class="material-symbols-rounded icon-svg">two_wheeler</span>
                            <span class="text-xs font-medium">‡∏à‡∏¢‡∏¢.</span>
                        </button>
                        <button onclick="setMode('walk')" id="mode-walk" class="mode-btn p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 flex flex-col items-center gap-1" role="radio" aria-checked="false">
                            <span class="material-symbols-rounded icon-svg">directions_walk</span>
                            <span class="text-xs font-medium">‡πÄ‡∏î‡∏¥‡∏ô</span>
                        </button>
                    </div>

                    <!-- Route Stats -->
                    <div id="route-stats" class="hidden">
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 rounded-xl p-4 mb-4">
                            <div class="flex items-baseline justify-between mb-4">
                                <div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</div>
                                    <div id="res-dist" class="text-2xl font-bold text-slate-800 dark:text-white">0 ‡∏Å‡∏°.</div>
                                </div>
                                <div class="text-center flex-1">
                                    <div id="traffic-indicator" class="inline-block">
                                        <span class="traffic-light green"></span>
                                        <span class="text-xs text-slate-500 dark:text-slate-400 ml-2">‡πÑ‡∏´‡∏•‡∏õ‡∏Å‡∏ï‡∏¥</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-slate-500 dark:text-slate-400">ETA</div>
                                    <div id="res-time" class="text-xl font-semibold text-primary-600 dark:text-primary-400">0 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-slate-500 dark:text-slate-400" id="res-speed-info">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: 50 ‡∏Å‡∏°./‡∏ä‡∏°.</span>
                                <div id="recalc-badge" class="hidden recalc-indicator recalc-badge-pulse">
                                    <span class="material-symbols-rounded text-xs icon-svg">refresh</span>
                                    <span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="startNav()" class="w-full py-3 bg-gradient-to-r from-primary-600 to-indigo-600 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-rounded icon-svg">navigation</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢
                        </button>
                    </div>
                </div>
            </div>
            
            <button id="d-btn-stop" onclick="stopNav()" class="hidden w-full py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold shadow-lg mt-auto mb-4 flex items-center justify-center gap-2">
                <span class="material-symbols-rounded icon-svg">stop_circle</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            </button>
        </aside>

        <!-- Map Container -->
        <div class="flex-1 relative bg-slate-200 dark:bg-slate-800 lg:p-4 pb-0 h-full">
            <div class="map-container shadow-inner">
                <div id="map"></div>
                
                <!-- Map Controls -->
                <div class="hidden lg:flex absolute right-4 bottom-8 flex-col gap-3 z-[5]">
                    <button onclick="panToCurrentLocation()" class="w-12 h-12 bg-white dark:bg-slate-900 rounded-xl shadow-floating flex items-center justify-center text-primary-600 dark:text-primary-400 hover:bg-primary-50 active:scale-95 transition-all">
                        <span class="material-symbols-rounded icon-svg">my_location</span>
                    </button>
                    <div class="flex flex-col bg-white dark:bg-slate-900 rounded-xl shadow-floating overflow-hidden">
                        <button onclick="map.zoom(map.zoom()+1, true)" class="w-12 h-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><span class="material-symbols-rounded icon-svg">add</span></button>
                        <div class="h-[1px] bg-slate-100 dark:bg-slate-800"></div>
                        <button onclick="map.zoom(map.zoom()-1, true)" class="w-12 h-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><span class="material-symbols-rounded icon-svg">remove</span></button>
                    </div>
                </div>

                <!-- Live Navigation HUD -->
                <div id="live-nav-hud" class="hidden absolute inset-0 flex flex-col pointer-events-none z-20">
                    <!-- Turn Card -->
                    <div id="turn-card" class="turn-card absolute top-4 left-1/2 -translate-x-1/2 max-w-md w-full pointer-events-auto">
                        <div class="bg-white/95 dark:bg-slate-900/95 live-nav-hud rounded-2xl shadow-floating p-4 mx-4">
                            <div class="flex items-center gap-4">
                                <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-primary-50 to-primary-100 dark:from-primary-900/30 dark:to-primary-800/30 flex items-center justify-center flex-shrink-0">
                                    <span id="turn-icon" class="text-4xl">‚¨ÜÔ∏è</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-lg font-bold text-slate-800 dark:text-white truncate" id="turn-instruction">‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÑ‡∏õ</div>
                                    <div class="text-sm text-slate-600 dark:text-slate-300 truncate" id="street-name">‡∏ñ‡∏ô‡∏ô‡∏™‡∏¢‡∏≤‡∏°</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400" id="distance-next">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: 500 ‡∏°.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Stats -->
                    <div class="absolute bottom-8 left-4 pointer-events-auto">
                        <div class="bg-white/95 dark:bg-slate-900/95 live-nav-hud rounded-2xl shadow-floating p-4">
                            <div class="flex items-center gap-6 min-w-[280px]">
                                <div class="text-center">
                                    <div class="text-xs text-slate-500 dark:text-slate-400 font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</div>
                                    <div class="text-2xl font-bold text-slate-800 dark:text-white" id="current-speed">0</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-300">‡∏Å‡∏°./‡∏ä‡∏°.</div>
                                </div>
                                <div class="w-[1px] h-12 bg-slate-200 dark:bg-slate-700"></div>
                                <div class="text-center">
                                    <div class="text-xs text-slate-500 dark:text-slate-400 font-medium">ETA</div>
                                    <div class="text-2xl font-bold text-primary-600 dark:text-primary-400" id="eta-remaining">0 ‡∏ô.</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-300" id="arrival-time">--:--</div>
                                </div>
                                <div class="w-[1px] h-12 bg-slate-200 dark:bg-slate-700"></div>
                                <div class="text-center">
                                    <div class="text-xs text-slate-500 dark:text-slate-400 font-medium">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                                    <div class="text-2xl font-bold text-slate-800 dark:text-white" id="distance-remaining">0 ‡∏Å‡∏°.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Traffic Status HUD -->
                    <div class="absolute bottom-8 right-4 pointer-events-auto">
                        <div class="bg-white/95 dark:bg-slate-900/95 live-nav-hud rounded-2xl shadow-floating p-3">
                            <div class="flex items-center gap-2">
                                <span class="traffic-light green" id="hud-traffic-light"></span>
                                <div>
                                    <div class="text-xs font-bold text-slate-800 dark:text-white" id="hud-traffic-status">‡πÑ‡∏´‡∏•‡∏õ‡∏Å‡∏ï‡∏¥</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400" id="hud-traffic-source">TomTom (100%) - 09:21:08</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Panel -->
        <div class="mobile-panel flex-col absolute inset-0 z-20 pointer-events-none">
            
            <div id="m-top-bar" class="w-full p-4 pointer-events-auto flex flex-col gap-2 transition-transform duration-300">
                <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-floating flex items-center p-2 pr-3">
                    <a href="dashboard.html" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-500 dark:text-slate-400">
                        <span class="material-symbols-rounded icon-svg">arrow_back</span>
                    </a>
                    <input type="text" id="m-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="flex-1 bg-transparent border-none outline-none text-base px-2 text-slate-800 dark:text-white" oninput="handleTyping('search', this.value, true)">
                    <div id="m-search-loading" class="hidden mr-2"><div class="loader"></div></div>
                    <div class="w-9 h-9 rounded-xl bg-primary-600 flex items-center justify-center text-white shadow-sm">
                        <span class="material-symbols-rounded text-lg icon-svg">search</span>
                    </div>
                </div>
                <div id="m-search-results" class="hidden bg-white dark:bg-slate-900 rounded-2xl shadow-xl overflow-hidden max-h-[60vh] overflow-y-auto border border-slate-100 dark:border-slate-800" role="listbox"></div>
            </div>

            <div class="flex-1"></div>

            <div id="m-nav-controls" class="hidden pointer-events-auto p-4 pb-8 w-full">
                 <button onclick="stopNav()" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white rounded-2xl font-bold shadow-floating flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded icon-svg">close</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                </button>
            </div>

            <div id="m-bottom-sheet" class="bg-white dark:bg-slate-900 rounded-t-3xl shadow-[0_-5px_30px_rgba(0,0,0,0.15)] pointer-events-auto transform transition-transform duration-300">
                <div class="w-12 h-1.5 bg-slate-300 dark:bg-slate-700 rounded-full mx-auto my-3"></div>
                
                <div class="px-5 pb-8">
                    <div id="m-view-default" class="grid grid-cols-3 gap-4 text-center">
                        <button onclick="panToCurrentLocation()" class="flex flex-col items-center gap-2 hover:opacity-80">
                            <div class="w-12 h-12 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center"><span class="material-symbols-rounded icon-svg">my_location</span></div>
                            <span class="text-xs">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
                        </button>
                        <button onclick="openMobileRoute()" class="flex flex-col items-center gap-2 hover:opacity-80">
                            <div class="w-12 h-12 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center"><span class="material-symbols-rounded icon-svg">directions</span></div>
                            <span class="text-xs">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</span>
                        </button>
                        <button onclick="toggleTheme()" class="flex flex-col items-center gap-2 hover:opacity-80">
                            <div class="w-12 h-12 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center"><span class="material-symbols-rounded theme-icon icon-svg">dark_mode</span></div>
                            <span class="text-xs">‡∏ò‡∏µ‡∏°</span>
                        </button>
                    </div>

                    <div id="m-view-route" class="hidden space-y-3">
                        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                            <span class="material-symbols-rounded text-blue-500 dark:text-blue-400 ml-1 icon-svg">trip_origin</span>
                            <input id="m-start-input" class="flex-1 bg-transparent border-none text-sm focus:ring-0 text-slate-800 dark:text-white" placeholder="‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" oninput="handleTyping('start', this.value, true)">
                            <button onclick="useCurrentLocation('start')" class="text-blue-500 dark:text-blue-400 p-1"><span class="material-symbols-rounded icon-svg">my_location</span></button>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800 p-2 rounded-xl border border-slate-100 dark:border-slate-700">
                            <span class="material-symbols-rounded text-red-500 dark:text-red-400 ml-1 icon-svg">location_on</span>
                            <input id="m-end-input" class="flex-1 bg-transparent border-none text-sm focus:ring-0 text-slate-800 dark:text-white" placeholder="‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" oninput="handleTyping('end', this.value, true)">
                        </div>
                        <div id="m-suggest-box" class="hidden bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 max-h-40 overflow-y-auto shadow-lg" role="listbox"></div>

                        <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-2 border border-slate-200 dark:border-slate-700">
                            <div class="text-xs font-semibold text-slate-600 dark:text-slate-300 mb-1 px-1">üõ£Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</div>
                            <div class="grid grid-cols-3 gap-1" role="radiogroup">
                                <button onclick="setRouteOption('fastest')" id="m-route-fastest" class="route-option-btn active p-1.5 rounded text-center border border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 text-[9px] font-bold" role="radio" aria-checked="true">‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î</button>
                                <button onclick="setRouteOption('eco')" id="m-route-eco" class="route-option-btn p-1.5 rounded text-center border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 text-[9px] font-bold" role="radio" aria-checked="false">‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î</button>
                                <button onclick="setRouteOption('safe')" id="m-route-safe" class="route-option-btn p-1.5 rounded text-center border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 text-[9px] font-bold" role="radio" aria-checked="false">‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2" role="radiogroup">
                            <button onclick="setMode('drive')" id="m-mode-drive" class="mode-btn active p-2 rounded-lg border border-primary-600 bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 text-center" role="radio" aria-checked="true"><span class="material-symbols-rounded block mx-auto icon-svg">directions_car</span><span class="text-[10px]">‡∏£‡∏ñ</span></button>
                            <button onclick="setMode('bike')" id="m-mode-bike" class="mode-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 text-center" role="radio" aria-checked="false"><span class="material-symbols-rounded block mx-auto icon-svg">two_wheeler</span><span class="text-[10px]">‡∏à‡∏¢‡∏¢.</span></button>
                            <button onclick="setMode('walk')" id="m-mode-walk" class="mode-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 text-center" role="radio" aria-checked="false"><span class="material-symbols-rounded block mx-auto icon-svg">directions_walk</span><span class="text-[10px]">‡πÄ‡∏î‡∏¥‡∏ô</span></button>
                        </div>

                        <div id="m-route-info" class="hidden flex-col gap-3 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 rounded-xl p-4">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-sm text-slate-500 dark:text-slate-400">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á <b id="m-dist-val" class="text-slate-800 dark:text-white">0 ‡∏Å‡∏°.</b></span>
                                <span class="text-sm text-slate-500 dark:text-slate-400">‡πÄ‡∏ß‡∏•‡∏≤ <b id="m-time-val" class="text-primary-600 dark:text-primary-400">0 ‡∏ô‡∏≤‡∏ó‡∏µ</b></span>
                            </div>
                            <button onclick="startNav()" class="w-full bg-primary-600 hover:bg-primary-700 text-white py-3 rounded-xl font-bold shadow-md transition-colors">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢</button>
                        </div>
                        <button onclick="resetMobileView()" class="w-full text-center text-sm text-slate-400 dark:text-slate-500 p-2 hover:text-slate-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============================================================================
        // üîë Configuration
        // ============================================================================
        
        const TOMTOM_API_KEY = 'xVYkUCtIMaUcSiNGJveZEZ5Wi14NP4m8';
        const LONGDO_API_KEY = 'bfe0b1b41b9bd6f49ab8eae336fe80dc';
        
        const THAILAND_BOUNDS = {
            north: 20.5, south: 5.6, east: 105.6, west: 97.3
        };

        const TURN_ICONS = {
            'straight': '‚¨ÜÔ∏è', 'turn-right': '‚û°Ô∏è', 'turn-left': '‚¨ÖÔ∏è',
            'turn-sharp-right': '‚ÜóÔ∏è', 'turn-sharp-left': '‚ÜñÔ∏è',
            'turn-slight-right': '‚§¥Ô∏è', 'turn-slight-left': '‚§µÔ∏è',
            'uturn-right': '‚Ü©Ô∏è', 'uturn-left': '‚Ü™Ô∏è',
            'ramp-right': '‚¨áÔ∏è', 'ramp-left': '‚¨áÔ∏è',
            'roundabout': 'üîÑ', 'destination': 'üéØ',
            'exit': '‚ÜóÔ∏è', 'enter': '‚¨ÖÔ∏è'
        };

        // ============================================================================
        // üéÆ Global Variables
        // ============================================================================
        
        let map, userMarker = null, currentPos = null, watchId = null;
        let searchTimer = null, requestController = null;
        let startLocation = null, endLocation = null;
        let currentMode = 'drive', currentRouteOption = 'fastest';
        let isNavigating = false, gpsTimeout = null, lastKnownPosition = null;
        let trafficCache = new Map(), lastTrafficUpdate = 0;
        let navigationRoute = null, currentTurnIndex = 0;
        let lastRecalcTime = 0, lastRecalcPos = null;
        let navigationInterval = null, searchCache = new Map();
        let routeInstructions = [], realTimeSpeed = 0;
        let previousSpeed = 0, speedUpdateTime = Date.now();
        
        // ‚úÖ Flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
        let isAutoRecalculating = false;
        let lastCalculationParams = {
            startLat: null,
            startLon: null,
            endLat: null,
            endLon: null,
            mode: 'drive',
            option: 'fastest'
        };

        // ============================================================================
        // üó∫Ô∏è Map Initialization
        // ============================================================================

        function initMap() {
            try {
                map = new longdo.Map({
                    placeholder: document.getElementById('map'),
                    language: 'th',
                    lastView: false
                });
                
                map.Ui.LayerSelector.visible(true); 
                map.Ui.Toolbar.visible(false);
                map.Ui.Zoombar.visible(false);
                map.Ui.DPad.visible(false);
                map.Ui.Scale.visible(true);

                checkLocationPermission();
                map.location({ lon: 100.5018, lat: 13.7563 }, true);
                map.zoom(12);
            } catch (e) { 
                console.error("Map Error", e); 
            }
        }

        // ============================================================================
        // üìç Location Services
        // ============================================================================

        function isInThailand(lat, lon) {
            return lat >= THAILAND_BOUNDS.south && lat <= THAILAND_BOUNDS.north && 
                   lon >= THAILAND_BOUNDS.west && lon <= THAILAND_BOUNDS.east;
        }

        function checkLocationPermission() {
            if (!navigator.geolocation) { 
                showToast("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS", "error"); 
                return; 
            }
            
            document.getElementById('gps-status').classList.remove('hidden');
            
            gpsTimeout = setTimeout(() => {
                if (!currentPos) {
                    document.getElementById('gps-status').classList.add('hidden');
                    showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô GPS ‡πÑ‡∏î‡πâ", "warning");
                    document.getElementById('location-modal').classList.remove('hidden');
                }
            }, 8000);
            
            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    clearTimeout(gpsTimeout);
                    const { latitude: lat, longitude: lon } = pos.coords;
                    
                    if (!isInThailand(lat, lon)) {
                        showToast("‚ö†Ô∏è ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢", "warning");
                        document.getElementById('gps-status').classList.add('hidden');
                        return;
                    }
                    
                    document.getElementById('gps-status').classList.add('hidden');
                    lastKnownPosition = pos;
                    startGPSTracking(); 
                },
                (err) => { 
                    clearTimeout(gpsTimeout);
                    document.getElementById('gps-status').classList.add('hidden');
                    document.getElementById('location-modal').classList.remove('hidden'); 
                },
                { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
            );
        }

        function requestLocationPermission() {
            document.getElementById('location-modal').classList.add('hidden');
            checkLocationPermission();
        }

        function startGPSTracking() {
            if (!navigator.geolocation) return;
            
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude: lat, longitude: lon, speed, accuracy } = pos.coords;
                    
                    if (!isInThailand(lat, lon)) {
                        showToast("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢", "warning");
                        return;
                    }
                    
                    if (accuracy < 50 || !currentPos) {
                        currentPos = { lat, lon, accuracy };
                        realTimeSpeed = speed ? Math.round(speed * 3.6) : 0;
                        updateUserMarker(lat, lon);
                        
                        if (!userMarker?.initDone && !isNavigating && map) {
                            map.location({ lon, lat }, true);
                            map.zoom(16);
                            if (userMarker) userMarker.initDone = true;
                        }
                    }
                    
                    if (isNavigating && navigationRoute && currentPos) {
                        const deviationDistance = calculateDistance(lat, lon, navigationRoute.end.lat, navigationRoute.end.lon);
                        if (deviationDistance > 0.1 && Date.now() - lastRecalcTime > 5000) {
                            lastRecalcTime = Date.now();
                            recalculateRoute();
                        }
                    }
                    
                    if (isNavigating && map) { 
                        map.location({ lon, lat }, true); 
                    }
                    
                    document.getElementById('location-modal').classList.add('hidden');
                },
                (err) => { 
                    if (lastKnownPosition && !currentPos) {
                        const { latitude: lat, longitude: lon } = lastKnownPosition.coords;
                        if (isInThailand(lat, lon)) {
                            currentPos = { lat, lon };
                            updateUserMarker(lat, lon);
                        }
                    }
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }
            );
        }

        function updateUserMarker(lat, lon) {
            if (!map) return;
            if (userMarker?.obj) {
                try { map.Overlays.remove(userMarker.obj); } catch (e) {}
            }
            
            const marker = new longdo.Marker({ lon, lat }, {
                icon: { html: `<div class="gps-marker-icon"></div>`, offset: { x: 11, y: 11 } },
                weight: 999
            });
            
            try {
                map.Overlays.add(marker);
                userMarker = { obj: marker, initDone: userMarker?.initDone || false };
            } catch (e) {}
        }

        // ============================================================================
        // üîÑ Distance Calculation
        // ============================================================================

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // ============================================================================
        // üö¶ Real-time Traffic Data
        // ============================================================================

        async function getRealTimeTraffic(lat, lon) {
            try {
                if (!isInThailand(lat, lon)) return null;

                const cacheKey = `${Math.round(lat*100)},${Math.round(lon*100)}`;
                const now = Date.now();
                
                if (trafficCache.has(cacheKey)) {
                    const cached = trafficCache.get(cacheKey);
                    if (now - cached.time < 60000) return cached.data;
                }

                const res = await fetch(`https://api.tomtom.com/traffic/services/4/flowSegmentData/relative/10/json?key=${TOMTOM_API_KEY}&point=${lat},${lon}&zoom=10`);
                if (!res.ok) return null;

                const data = await res.json();
                if (!data.flowSegmentData) return null;

                const trafficData = {
                    currentSpeed: data.flowSegmentData.currentSpeed,
                    freeFlowSpeed: data.flowSegmentData.freeFlowSpeed,
                    confidence: data.flowSegmentData.confidence,
                    trafficFactor: data.flowSegmentData.currentSpeed / data.flowSegmentData.freeFlowSpeed,
                    timestamp: new Date().toLocaleTimeString('th-TH')
                };

                trafficCache.set(cacheKey, { data: trafficData, time: now });
                lastTrafficUpdate = now;
                return trafficData;

            } catch (e) {
                console.error("Traffic API Error:", e);
                return null;
            }
        }

        function getTrafficStatus(trafficFactor) {
            if (trafficFactor <= 1.1) {
                return { color: 'green', text: '‡πÑ‡∏´‡∏•‡∏õ‡∏Å‡∏ï‡∏¥', class: 'green' };
            } else if (trafficFactor <= 1.5) {
                return { color: 'yellow', text: '‡∏ï‡∏¥‡∏î‡∏ö‡πâ‡∏≤‡∏á', class: 'yellow' };
            } else {
                return { color: 'red', text: '‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å', class: 'red' };
            }
        }

        function updateTrafficIndicator(trafficFactor, trafficSource) {
            const status = getTrafficStatus(trafficFactor);
            const indicator = document.getElementById('traffic-indicator');
            
            if (indicator) {
                const light = indicator.querySelector('.traffic-light');
                if (light) light.className = `traffic-light ${status.class}`;
                const text = indicator.querySelector('span:last-child');
                if (text) text.textContent = status.text;
            }

            const hudLight = document.getElementById('hud-traffic-light');
            const hudStatus = document.getElementById('hud-traffic-status');
            const hudSource = document.getElementById('hud-traffic-source');

            if (hudLight) hudLight.className = `traffic-light ${status.class}`;
            if (hudStatus) hudStatus.textContent = status.text;
            if (hudSource) hudSource.textContent = trafficSource;
        }

        // ============================================================================
        // üõ£Ô∏è Real Routing API - TomTom Routing Integration
        // ============================================================================

        async function getActualRouteInstructions(startLat, startLon, endLat, endLon) {
            try {
                let routeType = 'fastest';
                if (currentRouteOption === 'eco') routeType = 'eco';
                else if (currentRouteOption === 'safe') routeType = 'safest';

                const res = await fetch(
                    `https://api.tomtom.com/routing/1/calculateRoute/${startLat},${startLon}:${endLat},${endLon}/json?key=${TOMTOM_API_KEY}&routeType=${routeType}&language=th&traffic=true`
                );

                if (!res.ok) {
                    console.error("Routing API Error:", res.status);
                    return null;
                }

                const data = await res.json();
                
                if (!data.routes || data.routes.length === 0) {
                    return null;
                }

                const route = data.routes[0];
                const summary = route.summary;
                
                const instructions = [];
                
                if (route.guidance && route.guidance.instructions) {
                    route.guidance.instructions.forEach((instruction, index) => {
                        instructions.push({
                            index: index,
                            instruction: instruction.message || '‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÑ‡∏õ',
                            distance: instruction.distance || 0,
                            streetName: instruction.streetName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                            direction: instruction.direction || 'straight',
                            icon: TURN_ICONS[instruction.direction] || '‚¨ÜÔ∏è'
                        });
                    });
                }

                return {
                    distance: (summary.lengthInMeters / 1000).toFixed(1),
                    duration: Math.round(summary.travelTimeInSeconds / 60),
                    instructions: instructions,
                    coordinates: route.legs[0]?.points || []
                };

            } catch (e) {
                console.error("Routing Error:", e);
                return null;
            }
        }

        // ============================================================================
        // üîç IMPROVED Search with Strict Deduplication
        // ============================================================================

        function generatePlaceKey(item) {
            // ‚úÖ Generate strict unique key based on coordinates + name
            const latKey = Math.round(item.lat * 100000);
            const lonKey = Math.round(item.lon * 100000);
            const nameKey = (item.name || '').toLowerCase().trim();
            return `${latKey}-${lonKey}-${nameKey}`;
        }

        function handleTyping(type, val, isMobile = false) {
            const loadingId = isMobile ? 'm-search-loading' : (type === 'search'?'d-search-loading':'');
            const resultsId = isMobile ? (type === 'search' ? 'm-search-results' : 'm-suggest-box') : (type === 'search' ? 'd-search-results' : (type === 'start' ? 'd-suggest-start' : 'd-suggest-end'));
            
            if(loadingId) document.getElementById(loadingId).classList.remove('hidden');
            clearTimeout(searchTimer);
            
            if(requestController) requestController.abort();
            requestController = new AbortController();

            if(val.length < 2) {
                if(loadingId) document.getElementById(loadingId).classList.add('hidden');
                document.getElementById(resultsId).classList.add('hidden');
                return;
            }
            
            searchTimer = setTimeout(() => fetchSuggestions(val, type, isMobile, loadingId, resultsId), 500);
        }

        async function fetchSuggestions(keyword, type, isMobile, loadingId, resultsId) {
            try {
                const cacheKey = `${keyword}:${type}`;
                if (searchCache.has(cacheKey)) {
                    renderSuggestions(searchCache.get(cacheKey), type, isMobile, resultsId);
                    if(loadingId) document.getElementById(loadingId).classList.add('hidden');
                    return;
                }

                const res = await fetch(`https://search.longdo.com/mapsearch/json/search?keyword=${encodeURIComponent(keyword)}&limit=20&key=${LONGDO_API_KEY}`, {
                    signal: requestController.signal
                });
                const json = await res.json();
                
                // ‚úÖ IMPROVED DEDUPLICATION: ‡πÉ‡∏ä‡πâ generatePlaceKey ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö strict dedup
                const uniqueItems = deduplicateAndSortPlaces(json.data, currentPos).filter(item => 
                    isInThailand(item.lat, item.lon)
                ).slice(0, 10);
                
                searchCache.set(cacheKey, uniqueItems);
                renderSuggestions(uniqueItems, type, isMobile, resultsId);
            } catch (e) { 
                if (e.name !== 'AbortError') console.error(e);
            } 
            finally { if(loadingId) document.getElementById(loadingId).classList.add('hidden'); }
        }

        function deduplicateAndSortPlaces(items, sortByPos) {
            if(!items) return [];
            const seenKeys = new Set();
            const uniqueItems = [];

            // ‚úÖ STRICT DEDUPLICATION: ‡πÉ‡∏ä‡πâ coordinate-based key
            items.forEach(item => {
                const key = generatePlaceKey(item);
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueItems.push(item);
                }
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
            if (sortByPos) {
                uniqueItems.sort((a, b) => {
                    const distA = calculateDistance(sortByPos.lat, sortByPos.lon, a.lat, a.lon);
                    const distB = calculateDistance(sortByPos.lat, sortByPos.lon, b.lat, b.lon);
                    return distA - distB;
                });
            }

            return uniqueItems;
        }

        function renderSuggestions(items, type, isMobile, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if(items.length === 0) { 
                container.innerHTML = '<div class="p-3 text-center text-sm text-slate-500 dark:text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</div>';
                container.classList.remove('hidden');
                return; 
            }
            items.forEach((item) => {
                const el = document.createElement('div');
                el.className = 'p-3 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-3 border-b border-slate-100 dark:border-slate-700 last:border-0 transition-colors';
                el.setAttribute('role', 'option');
                
                let distanceText = '';
                if (currentPos) {
                    const dist = calculateDistance(currentPos.lat, currentPos.lon, item.lat, item.lon);
                    distanceText = `<div class="text-xs text-primary-600 dark:text-primary-400 font-medium">${dist.toFixed(1)} ‡∏Å‡∏°.</div>`;
                }
                
                el.innerHTML = `<span class="material-symbols-rounded text-slate-400 dark:text-slate-500 icon-svg">location_on</span><div class="min-w-0 flex-1"><div class="text-sm font-medium truncate dark:text-slate-200">${item.name}</div><div class="text-xs text-slate-400 dark:text-slate-500 truncate">${item.address || ''}</div>${distanceText}</div>`;
                el.onclick = () => selectPlace(item, type, isMobile, containerId);
                container.appendChild(el);
            });
            container.classList.remove('hidden');
        }

        function selectPlace(place, type, isMobile, containerId) {
            document.getElementById(containerId).classList.add('hidden');
            if(type === 'search') {
                if(isMobile) document.getElementById('m-search-input').value = place.name;
                else document.getElementById('d-search-input').value = place.name;
                if(map) {
                    map.location({ lon: place.lon, lat: place.lat }, true);
                    map.zoom(15);
                    map.Overlays.add(new longdo.Marker({ lon: place.lon, lat: place.lat }));
                }
                endLocation = place;
            } else {
                if(type === 'start') startLocation = place; else endLocation = place;
                const inputId = isMobile ? (type === 'start' ? 'm-start-input' : 'm-end-input') : (type === 'start' ? 'd-start-input' : 'd-end-input');
                document.getElementById(inputId).value = place.name;
                if(startLocation && endLocation) calculateRoute();
            }
        }

        function useCurrentLocation(type) {
            if(!currentPos) { showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "error"); return; }
            const place = { lat: currentPos.lat, lon: currentPos.lon, name: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" };
            if(type === 'start') {
                document.getElementById('d-start-input').value = place.name;
                document.getElementById('m-start-input').value = place.name;
                startLocation = place;
            }
            if(startLocation && endLocation) calculateRoute();
        }

        // ============================================================================
        // üõ£Ô∏è Route Calculation with Real-time Traffic + Auto Recalculate
        // ============================================================================

        async function calculateRoute() {
            if(!startLocation || !endLocation) return;
            
            // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á recalculate ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const newParams = {
                startLat: startLocation.lat,
                startLon: startLocation.lon,
                endLat: endLocation.lat,
                endLon: endLocation.lon,
                mode: currentMode,
                option: currentRouteOption
            };

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const isParametersChanged = 
                lastCalculationParams.startLat !== newParams.startLat ||
                lastCalculationParams.startLon !== newParams.startLon ||
                lastCalculationParams.endLat !== newParams.endLat ||
                lastCalculationParams.endLon !== newParams.endLon ||
                lastCalculationParams.mode !== newParams.mode ||
                lastCalculationParams.option !== newParams.option;

            // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô recalc badge ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
            if (isParametersChanged) {
                document.getElementById('recalc-badge').classList.add('hidden');
            }

            try {
                const routeData = await getActualRouteInstructions(
                    startLocation.lat, startLocation.lon,
                    endLocation.lat, endLocation.lon
                );

                if (!routeData) {
                    showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "error");
                    return;
                }

                // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                let adjustedTime = routeData.duration;
                let displayDistance = parseFloat(routeData.distance);
                
                // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
                if (currentMode === 'bike') {
                    adjustedTime = Math.round(routeData.duration * 1.5);
                } else if (currentMode === 'walk') {
                    adjustedTime = Math.round(routeData.duration * 3.5);
                }

                // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                if (currentRouteOption === 'eco') {
                    adjustedTime = Math.round(adjustedTime * 1.1);
                } else if (currentRouteOption === 'safe') {
                    adjustedTime = Math.round(adjustedTime * 1.15);
                }

                const distStr = displayDistance + " ‡∏Å‡∏°.";
                const timeStr = adjustedTime > 60 ? 
                    `${Math.floor(adjustedTime/60)} ‡∏ä‡∏°. ${adjustedTime%60} ‡∏ô.` : 
                    `${adjustedTime} ‡∏ô‡∏≤‡∏ó‡∏µ`;

                let trafficSource = 'Real-time';
                let trafficFactor = 1;
                const realTraffic = await getRealTimeTraffic(startLocation.lat, startLocation.lon);
                
                if (realTraffic) {
                    trafficFactor = realTraffic.trafficFactor;
                    trafficSource = `TomTom (${Math.round(realTraffic.confidence * 100)}%) - ${realTraffic.timestamp}`;
                    
                    const adjustedTrafficTime = Math.round(adjustedTime * trafficFactor);
                    document.getElementById('res-time').innerText = adjustedTrafficTime > 60 ? 
                        `${Math.floor(adjustedTrafficTime/60)} ‡∏ä‡∏°. ${adjustedTrafficTime%60} ‡∏ô.` : 
                        `${adjustedTrafficTime} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                } else {
                    document.getElementById('res-time').innerText = timeStr;
                }

                // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
                let avgSpeed = 50;
                if (currentMode === 'bike') avgSpeed = 30;
                else if (currentMode === 'walk') avgSpeed = 5;

                const speedInfo = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${Math.round(avgSpeed)} ‡∏Å‡∏°./‡∏ä‡∏°.`;

                document.getElementById('route-stats').classList.remove('hidden');
                document.getElementById('res-dist').innerText = distStr;
                document.getElementById('res-speed-info').innerText = speedInfo;
                
                updateTrafficIndicator(trafficFactor, trafficSource);

                document.getElementById('m-route-info').classList.remove('hidden');
                document.getElementById('m-route-info').classList.add('flex');
                document.getElementById('m-dist-val').innerText = distStr;
                document.getElementById('m-time-val').innerText = timeStr;

                navigationRoute = {
                    start: startLocation,
                    end: endLocation,
                    distance: displayDistance,
                    time: adjustedTime,
                    trafficFactor: trafficFactor,
                    instructions: routeData.instructions || [],
                    coordinates: routeData.coordinates || []
                };

                routeInstructions = navigationRoute.instructions;

                // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å parameters ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
                lastCalculationParams = { ...newParams };

                if(map) {
                    map.Route.clear();
                    map.Route.add(new longdo.Marker({ lon: startLocation.lon, lat: startLocation.lat }));
                    map.Route.add(new longdo.Marker({ lon: endLocation.lon, lat: endLocation.lat }));
                    map.Route.search();
                    if(!isNavigating) map.zoom(10);
                }

                showToast(`‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${currentMode} - ${currentRouteOption})`, "success");
            } catch (e) {
                console.error("Route calculation error:", e);
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á", "error");
            }
        }

        // ============================================================================
        // üöó Navigation Start
        // ============================================================================

        function startNav() {
            if(!startLocation || !endLocation) { 
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á", "warning"); 
                return; 
            }
            
            showToast("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á...", "success");
            isNavigating = true;
            currentTurnIndex = 0;
            lastRecalcTime = Date.now();
            
            const targetLat = startLocation.lat || currentPos?.lat;
            const targetLon = startLocation.lon || currentPos?.lon;
            
            if (targetLat && targetLon && map) {
                map.location({ lon: targetLon, lat: targetLat }, true);
                setTimeout(() => map.zoom(19, true), 500);
            }

            document.getElementById('live-nav-hud').classList.remove('hidden');
            updateLiveNavigation();
            navigationInterval = setInterval(updateLiveNavigation, 1000);

            if(window.innerWidth < 1024) {
                document.getElementById('m-bottom-sheet').classList.add('translate-y-[110%]');
                document.getElementById('m-top-bar').classList.add('-translate-y-[110%]');
                document.getElementById('m-nav-controls').classList.remove('hidden');
            } else {
                document.getElementById('d-panel-route').classList.add('hidden');
                document.getElementById('d-btn-stop').classList.remove('hidden');
            }
        }

        // ============================================================================
        // üìç Live Navigation Update - Real-time Speed & Traffic
        // ============================================================================

        async function updateLiveNavigation() {
            if (!isNavigating || !navigationRoute || !currentPos) return;

            const distToDestination = calculateDistance(
                currentPos.lat, currentPos.lon,
                navigationRoute.end.lat, navigationRoute.end.lon
            );

            const traffic = await getRealTimeTraffic(currentPos.lat, currentPos.lon);
            const trafficFactor = traffic ? traffic.trafficFactor : 1;
            
            let avgSpeed = currentMode === 'drive' ? 50 : (currentMode === 'bike' ? 30 : 5);
            
            if (currentRouteOption === 'eco') avgSpeed = 45;
            else if (currentRouteOption === 'safe') avgSpeed = 40;

            const timeRemainingMinutes = Math.round((distToDestination / (avgSpeed * trafficFactor)) * 60);
            const arrivalTime = new Date(Date.now() + timeRemainingMinutes * 60000);
            const arrivalTimeStr = `${arrivalTime.getHours().toString().padStart(2, '0')}:${arrivalTime.getMinutes().toString().padStart(2, '0')}`;

            document.getElementById('current-speed').textContent = realTimeSpeed;
            document.getElementById('eta-remaining').textContent = `${timeRemainingMinutes} ‡∏ô.`;
            document.getElementById('arrival-time').textContent = arrivalTimeStr;
            document.getElementById('distance-remaining').textContent = distToDestination.toFixed(1);

            updateTurnByTurn();
            updateTrafficIndicator(trafficFactor, traffic ? `TomTom (${Math.round(traffic.confidence * 100)}%) - ${traffic.timestamp}` : 'GPS-based');
        }

        // ============================================================================
        // üîÑ Turn-by-Turn Navigation
        // ============================================================================

        function updateTurnByTurn() {
            if (routeInstructions.length === 0 || currentTurnIndex >= routeInstructions.length) {
                return;
            }

            const turn = routeInstructions[currentTurnIndex];
            const turnIcon = turn.icon || '‚¨ÜÔ∏è';
            
            document.getElementById('turn-icon').textContent = turnIcon;
            document.getElementById('turn-instruction').textContent = turn.instruction;
            document.getElementById('street-name').textContent = turn.streetName;
            document.getElementById('distance-next').textContent = turn.distance > 0 ? 
                `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${turn.distance} ‡πÄ‡∏°‡∏ï‡∏£` : '‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß';

            setTimeout(() => {
                if (currentTurnIndex < routeInstructions.length - 1) {
                    currentTurnIndex++;
                }
            }, 30000);
        }

        // ============================================================================
        // üîÑ Auto Re-route
        // ============================================================================

        async function recalculateRoute() {
            if (!startLocation || !endLocation || !currentPos) return;
            if (isAutoRecalculating) return;
            
            isAutoRecalculating = true;
            showToast("‚ö†Ô∏è ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà...", "info");
            startLocation = { lat: currentPos.lat, lon: currentPos.lon, name: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" };
            await calculateRoute();
            isAutoRecalculating = false;
        }

        // ============================================================================
        // üõë Navigation Stop
        // ============================================================================

        function stopNav() {
            isNavigating = false;
            currentTurnIndex = 0;
            navigationRoute = null;
            routeInstructions = [];
            
            showToast("‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á");
            
            if (navigationInterval) {
                clearInterval(navigationInterval);
                navigationInterval = null;
            }

            if(map) {
                map.Route.clear();
                map.zoom(15, true);
            }

            document.getElementById('live-nav-hud').classList.add('hidden');

            if(window.innerWidth < 1024) {
                document.getElementById('m-bottom-sheet').classList.remove('translate-y-[110%]');
                document.getElementById('m-top-bar').classList.remove('-translate-y-[110%]');
                document.getElementById('m-nav-controls').classList.add('hidden');
                resetMobileView();
            } else {
                document.getElementById('d-panel-route').classList.remove('hidden');
                document.getElementById('d-btn-stop').classList.add('hidden');
            }
        }

        // ============================================================================
        // üéõÔ∏è Route & Mode Options - WITH AUTO RECALCULATE
        // ============================================================================

        function setRouteOption(option) {
            currentRouteOption = option;
            
            ['fastest', 'eco', 'safe'].forEach(opt => {
                const btn = document.getElementById(`route-${opt}`);
                const mbtn = document.getElementById(`m-route-${opt}`);
                if (btn) {
                    if (opt === option) {
                        btn.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-700', 'dark:text-primary-300');
                        btn.classList.remove('border-slate-200', 'dark:border-slate-700', 'text-slate-600', 'dark:text-slate-400');
                    } else {
                        btn.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-700', 'dark:text-primary-300');
                        btn.classList.add('border-slate-200', 'dark:border-slate-700', 'text-slate-600', 'dark:text-slate-400');
                    }
                }
                if (mbtn) {
                    if (opt === option) {
                        mbtn.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-700', 'dark:text-primary-300');
                        mbtn.classList.remove('border-slate-200', 'dark:border-slate-700', 'text-slate-600', 'dark:text-slate-400');
                    } else {
                        mbtn.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-700', 'dark:text-primary-300');
                        mbtn.classList.add('border-slate-200', 'dark:border-slate-700', 'text-slate-600', 'dark:text-slate-400');
                    }
                }
            });

            // ‚úÖ AUTO RECALCULATE when option changes
            if(startLocation && endLocation && !isNavigating) {
                document.getElementById('recalc-badge').classList.remove('hidden');
                document.getElementById('recalc-badge').classList.add('recalc-badge-pulse');
                calculateRoute();
            }
        }

        function setMode(mode) {
            currentMode = mode;
            ['drive', 'bike', 'walk'].forEach(m => {
                ['d', 'm'].forEach(prefix => {
                    const btn = document.getElementById(`${prefix}-mode-${m}`);
                    if (btn) {
                        if (m === mode) {
                            btn.classList.add('active', 'border-primary-600', 'bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-700', 'dark:text-primary-300');
                            btn.classList.remove('border-slate-200', 'dark:border-slate-700', 'text-slate-600', 'dark:text-slate-400');
                            btn.setAttribute('aria-checked', 'true');
                        } else {
                            btn.classList.remove('active', 'border-primary-600', 'bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-700', 'dark:text-primary-300');
                            btn.classList.add('border-slate-200', 'dark:border-slate-700', 'text-slate-600', 'dark:text-slate-400');
                            btn.setAttribute('aria-checked', 'false');
                        }
                    }
                });
            });
            
            // ‚úÖ AUTO RECALCULATE when mode changes
            if(startLocation && endLocation && !isNavigating) {
                document.getElementById('recalc-badge').classList.remove('hidden');
                document.getElementById('recalc-badge').classList.add('recalc-badge-pulse');
                calculateRoute();
            }
        }

        // ============================================================================
        // üì± Mobile UI
        // ============================================================================

        function openMobileRoute() { 
            document.getElementById('m-start-input').value = '';
            document.getElementById('m-end-input').value = '';
            document.getElementById('m-view-default').classList.add('hidden'); 
            document.getElementById('m-view-route').classList.remove('hidden'); 
        }
        
        function resetMobileView() { 
            document.getElementById('m-view-route').classList.add('hidden'); 
            document.getElementById('m-view-default').classList.remove('hidden'); 
        }
        
        function panToCurrentLocation() { 
            if(currentPos && map) { 
                map.location({ lon: currentPos.lon, lat: currentPos.lat }, true); 
                map.zoom(17); 
            } else {
                showToast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "warning");
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelectorAll('.theme-icon').forEach(i => i.innerText = isDark ? 'light_mode' : 'dark_mode');
        }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `bg-white dark:bg-slate-800 border-l-4 ${type==='success'?'border-green-500':(type==='error'?'border-red-500':'border-blue-500')} p-3 rounded-lg shadow-lg flex items-center gap-3 transition-all transform translate-y-2 opacity-0`;
            el.innerHTML = `<span class="text-sm font-medium dark:text-white">${msg}</span>`;
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.remove('translate-y-2', 'opacity-0'));
            setTimeout(() => el.remove(), 3000);
        }

        function switchTab(tab) {
            ['search', 'route'].forEach(t => {
                const tabBtn = document.getElementById(`d-tab-${t}`);
                const panel = document.getElementById(`d-panel-${t}`);
                if (tabBtn && panel) {
                    if (t === tab) {
                        tabBtn.className = 'flex-1 py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 bg-white dark:bg-slate-700 shadow text-primary-600 dark:text-primary-400';
                        tabBtn.setAttribute('aria-selected', 'true');
                        panel.classList.remove('hidden');
                    } else {
                        tabBtn.className = 'flex-1 py-2.5 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-700';
                        tabBtn.setAttribute('aria-selected', 'false');
                        panel.classList.add('hidden');
                    }
                }
            });
        }

        function initializeTheme() {
            if (localStorage.theme === 'light') {
                document.documentElement.classList.remove('dark');
                document.querySelectorAll('.theme-icon').forEach(i => i.innerText = 'dark_mode');
            } else if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.querySelectorAll('.theme-icon').forEach(i => i.innerText = 'light_mode');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.querySelectorAll('.theme-icon').forEach(i => i.innerText = 'light_mode');
            }
        }

        window.addEventListener('load', () => {
            initializeTheme();
            initMap();
        });
    </script>
</body>
</html>
