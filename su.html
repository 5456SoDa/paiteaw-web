<!DOCTYPE html>
<html lang="th" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="สมัครสมาชิก - จัดการเวลาเที่ยว-ค่าใช้จ่าย">
  <title>สมัครสมาชิก - จัดการเวลาเที่ยว-ค่าใช้จ่าย</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="utils.js" defer></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Kanit', 'sans-serif'] },
          animation: {
            'fade-in-scale': 'fadeInScale 0.5s ease-out',
          },
          keyframes: {
            fadeInScale: {
              '0%': { opacity: '0', transform: 'scale(0.95)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html {
      scroll-behavior: smooth;
      overflow-x: hidden;
    }

    body {
      font-family: 'Kanit', sans-serif;
      overflow-x: hidden;
    }

    .bg-slider {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: opacity 1.5s ease-in-out;
      opacity: 0;
      will-change: opacity;
    }

    @media (max-width: 768px) {
      .bg-slider {
        background-attachment: scroll;
      }
    }

    .bg-slider.active {
      opacity: 1;
    }

    .error-message {
      display: none;
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .input-field {
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
    }

    .input-field.error {
      border-color: #ef4444 !important;
    }

    .toggle-password {
      user-select: none;
      transition: color 0.2s ease;
    }

    .toggle-password:hover {
      color: #4f46e5 !important;
    }

    .ripple-btn {
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .ripple-btn::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.35);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      pointer-events: none;
    }

    .ripple-btn:active::after {
      width: 200px;
      height: 200px;
      opacity: 1;
      transition: width 0.6s ease-out, height 0.6s ease-out, opacity 0.6s ease-out;
    }

    .dark .ripple-btn.bg-white::after {
      background: rgba(99, 102, 241, 0.2);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    /* ============ Password Strength Styling ============ */
    .password-strength-container {
      margin-top: 0.875rem;
    }

    .password-strength {
      height: 8px;
      border-radius: 4px;
      background-color: #e5e7eb;
      overflow: hidden;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .dark .password-strength {
      background-color: #374151;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .strength-bar {
      height: 100%;
      width: 0%;
      border-radius: 4px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.4s ease;
    }

    .strength-bar.weak {
      width: 33%;
      background: linear-gradient(90deg, #ef4444, #f87171);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }

    .strength-bar.medium {
      width: 66%;
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }

    .strength-bar.strong {
      width: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .strength-text {
      font-size: 0.875rem;
      margin-top: 0.625rem;
      font-weight: 600;
      transition: color 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .strength-text.weak {
      color: #dc2626;
    }

    .dark .strength-text.weak {
      color: #fca5a5;
    }

    .strength-text.medium {
      color: #d97706;
    }

    .dark .strength-text.medium {
      color: #fcd34d;
    }

    .strength-text.strong {
      color: #059669;
    }

    .dark .strength-text.strong {
      color: #6ee7b7;
    }

    /* ============ Password Requirement Info ============ */
    .password-info {
      font-size: 0.8125rem;
      margin-top: 0.625rem;
      padding: 0.75rem;
      background-color: #f3f4f6;
      border-radius: 6px;
      border-left: 4px solid #6366f1;
      line-height: 1.6;
    }

    .dark .password-info {
      background-color: #1f2937;
      border-left-color: #818cf8;
    }

    .password-info p {
      color: #6b7280;
      margin: 0;
      font-weight: 500;
    }

    .dark .password-info p {
      color: #d1d5db;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 1rem;
      backdrop-filter: blur(4px);
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      max-width: 90%;
      width: 520px;
      border-radius: 16px;
      padding: 2.5rem 2rem 2rem;
      position: relative;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      transform: scale(0.9);
      transition: transform 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    .dark .modal-content {
      background: #1e293b;
      color: #e2e8f0;
    }

    .modal.show .modal-content {
      transform: scale(1);
    }

    .modal-icon-img {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      display: block;
      border-radius: 50%;
      object-fit: contain;
      box-shadow: 0 8px 20px rgba(99,102,241,0.3);
    }

    @media (max-width: 640px) {
      .modal-icon-img {
        width: 64px;
        height: 64px;
      }

      .modal-content {
        width: 95%;
        padding: 2rem 1.5rem;
      }
    }

    .dark .modal-icon-img {
      box-shadow: 0 8px 20px rgba(99,102,241,0.5);
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 2rem;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.2s ease;
    }

    .close-btn:hover {
      color: #1f2937;
    }

    .dark .close-btn {
      color: #9ca3af;
    }

    .dark .close-btn:hover {
      color: #f1f5f9;
    }

    .profile-image-container {
      width: 120px;
      height: 120px;
      margin: 0 auto 1rem;
      border-radius: 50%;
      overflow: hidden;
      border-4 border-indigo-500 dark:border-indigo-400;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f3f4f6;
      transition: all 0.3s ease;
    }

    .profile-image-container:hover {
      box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
      transform: scale(1.05);
    }

    .profile-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .upload-overlay {
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    .profile-image-container:hover .upload-overlay {
      opacity: 1;
    }

    @media (max-width: 640px) {
      .profile-image-container {
        width: 100px;
        height: 100px;
      }
    }

    .rate-limit-warning {
      padding: 12px;
      background-color: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      color: #92400e;
      font-size: 14px;
      margin-bottom: 16px;
      display: none;
    }

    .dark .rate-limit-warning {
      background-color: #78350f;
      border-color: #b45309;
      color: #fcd34d;
    }

    .rate-limit-warning.show {
      display: block;
    }

    .modal-link {
      color: #6366f1;
      cursor: pointer;
      text-decoration: underline;
      font-weight: 500;
    }

    .dark .modal-link {
      color: #818cf8;
    }

    .modal-link:hover {
      color: #4f46e5;
    }

    .dark .modal-link:hover {
      color: #a5b4fc;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800">

  <!-- Background Slider -->
  <div class="fixed inset-0 z-0 hidden sm:block">
    <div id="bg1" class="bg-slider active" style="background-image: url('https://img5.pic.in.th/file/secure-sv1/1000478230.png');"></div>
    <div id="bg2" class="bg-slider" style="background-image: url('https://img2.pic.in.th/1000478232.png');"></div>
    <div id="bg3" class="bg-slider" style="background-image: url('https://img2.pic.in.th/1000478233.png');"></div>
    <div id="bg4" class="bg-slider" style="background-image: url('https://img2.pic.in.th/1000480947.jpg');"></div>
    <div id="bg5" class="bg-slider" style="background-image: url('https://img5.pic.in.th/file/secure-sv1/1000480946.jpg');"></div>
    <div id="bg6" class="bg-slider" style="background-image: url('https://img2.pic.in.th/1000480945.jpg');"></div>
    <div class="absolute inset-0 bg-black/55"></div>
  </div>

  <div class="relative z-10 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md mx-4 sm:mx-0 max-h-[95vh] overflow-y-auto animate-fade-in-scale">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8 sticky top-0 bg-white dark:bg-gray-800 pb-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-2 sm:gap-3 min-w-0">
        <img src="https://i.postimg.cc/d3Jnyv2F/11zon-cropped.png" alt="โลโก้" class="w-10 h-10 rounded-full object-cover flex-shrink-0" loading="lazy">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white truncate">สมัครสมาชิก</h1>
      </div>
      <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition flex-shrink-0" aria-label="สลับธีม">
        <span id="theme-icon" class="material-symbols-outlined text-gray-600 dark:text-gray-300">dark_mode</span>
      </button>
    </div>

    <!-- Rate Limit Warning -->
    <div id="rateLimitWarning" class="rate-limit-warning">
      <p id="rateLimitMessage"></p>
    </div>

    <!-- Register Form -->
    <form id="registerForm" class="space-y-5" novalidate>
      <!-- Username -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ชื่อผู้ใช้</label>
        <input 
          type="text" 
          id="username" 
          class="input-field w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 transition text-sm sm:text-base" 
          placeholder="ตัวอย่าง: soda_zen" 
          required 
          minlength="3" 
          maxlength="20"
          pattern="[a-zA-Z0-9._-]+"
        >
        <p id="usernameError" class="error-message">ชื่อผู้ใช้ต้องมี 3-20 ตัวอักษร (ตัวอักษร, ตัวเลข, _ . - เท่านั้น)</p>
      </div>

      <!-- Email -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">อีเมล</label>
        <input 
          type="email" 
          id="email" 
          class="input-field w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 transition text-sm sm:text-base" 
          placeholder="ตัวอย่าง: soda@example.com" 
          required
          autocomplete="email"
        >
        <p id="emailError" class="error-message">กรุณากรอกอีเมลให้ถูกต้อง</p>
      </div>

      <!-- Profile Photo -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">รูปโปรไฟล์ (เลือกจากอุปกรณ์)</label>
        <div class="flex flex-col items-center">
          <div class="profile-image-container" onclick="document.getElementById('profilePhoto').click()">
            <img id="profilePreview" src="https://i.postimg.cc/3wB0kP0D/default-avatar.png" alt="รูปโปรไฟล์" class="profile-image">
            <div class="upload-overlay">
              <span class="material-symbols-outlined text-2xl">add_a_photo</span>
            </div>
          </div>
          <input 
            type="file" 
            id="profilePhoto" 
            accept="image/jpeg,image/png,image/webp" 
            class="hidden"
          >
        </div>
        <p id="photoError" class="error-message text-center">กรุณาเลือกรูปโปรไฟล์ (jpg/png/webp, ไม่เกิน 5MB)</p>
      </div>

      <!-- Password -->
      <div class="input-group relative">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">รหัสผ่าน</label>
        <input 
          type="password" 
          id="password" 
          class="input-field w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 transition pr-10 text-sm sm:text-base" 
          placeholder="••••••••" 
          required 
          minlength="8"
        >
        <span id="togglePassword" class="toggle-password material-symbols-outlined absolute right-3 top-10 text-gray-500 dark:text-gray-400 cursor-pointer select-none hover:text-indigo-600 dark:hover:text-indigo-400">visibility</span>
        
        <!-- Password Strength Bar -->
        <div class="password-strength-container">
          <div class="password-strength">
            <div id="strengthBar" class="strength-bar"></div>
          </div>
          <p id="strengthText" class="strength-text" style="display: none;"></p>
        </div>

        <!-- Password Requirements Info -->
        <div class="password-info">
          <p>✓ 8+ ตัวอักษร  |  ✓ ตัวพิมพ์ใหญ่  |  ✓ ตัวเลข  |  ✓ อักขระพิเศษ (@!#$%)</p>
        </div>

        <p id="passwordError" class="error-message text-xs">รหัสผ่านต้องมี 8+ ตัวอักษร (มีตัวพิมพ์ใหญ่, พิมพ์เล็ก, ตัวเลข และอักขระพิเศษ @!#$%)</p>
      </div>

      <!-- Confirm Password -->
      <div class="input-group relative">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ยืนยันรหัสผ่าน</label>
        <input 
          type="password" 
          id="confirmPassword" 
          class="input-field w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 transition pr-10 text-sm sm:text-base" 
          placeholder="••••••••" 
          required
        >
        <span id="toggleConfirmPassword" class="toggle-password material-symbols-outlined absolute right-3 top-10 text-gray-500 dark:text-gray-400 cursor-pointer select-none hover:text-indigo-600 dark:hover:text-indigo-400">visibility</span>
        <p id="confirmPasswordError" class="error-message">รหัสผ่านไม่ตรงกัน</p>
      </div>

      <!-- Terms & Privacy -->
      <div class="flex items-start gap-2">
        <input 
          type="checkbox" 
          id="terms" 
          class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-1 flex-shrink-0" 
          required
        >
        <label for="terms" class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
          ฉันยอมรับ 
          <span class="modal-link" onclick="showModal('terms')">ข้อกำหนดการใช้งาน</span>
          และ 
          <span class="modal-link" onclick="showModal('privacy')">นโยบายความเป็นส่วนตัว</span>
        </label>
      </div>
      <p id="termsError" class="error-message text-center">กรุณายอมรับข้อกำหนดก่อนสมัคร</p>

      <!-- Submit Button -->
      <button 
        type="submit" 
        id="registerBtn" 
        disabled 
        class="ripple-btn w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition transform disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-indigo-600 text-sm sm:text-base"
      >
        <span id="btnText">สมัครสมาชิก</span>
        <span id="btnSpinner" class="spinner material-symbols-outlined hidden ml-2">hourglass_empty</span>
      </button>

      <!-- Divider -->
      <div class="relative my-4">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">หรือ</span>
        </div>
      </div>

      <!-- Google Signup Button -->
      <button 
        type="button" 
        id="googleSignup" 
        class="ripple-btn w-full py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg font-medium flex items-center justify-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-600 transition text-sm sm:text-base"
      >
        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5">
        <span id="googleBtnText">สมัครด้วย Google</span>
        <span id="googleSpinner" class="spinner material-symbols-outlined hidden">hourglass_empty</span>
      </button>
    </form>

    <!-- Login Link -->
    <p class="text-center mt-6 text-gray-600 dark:text-gray-400 text-sm sm:text-base">
      มีบัญชีอยู่แล้ว? 
      <a href="login.html" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">เข้าสู่ระบบ</a>
    </p>

    <!-- Back Link -->
    <div class="text-center mt-6">
      <a href="login.html" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 text-sm">← กลับไปหน้าเข้าสู่ระบบ</a>
    </div>
  </div>

  <!-- Modal Popup -->
  <div id="modal" class="modal fixed inset-0 bg-black/60 flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300" onclick="closeModal(event)">
    <div class="modal-content bg-white dark:bg-gray-800 max-w-[90%] w-full max-w-lg rounded-2xl p-8 relative shadow-2xl transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
      <span class="close-btn absolute top-4 right-5 text-3xl cursor-pointer text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" onclick="closeModal()">×</span>
      <img id="modal-icon" class="modal-icon-img" src="" alt="ไอคอน" loading="lazy" />
      <div id="modal-title" class="text-xl sm:text-2xl font-bold mb-4 text-center text-gray-900 dark:text-white"></div>
      <div id="modal-body" class="text-gray-700 dark:text-gray-300 space-y-4 text-center text-sm sm:text-base"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUMhtE1uw9vj7yzMKIZ_w769CrUDwEoww",
      authDomain: "paiteaw-web.firebaseapp.com",
      projectId: "paiteaw-web",
      storageBucket: "paiteaw-web.firebasestorage.app",
      messagingSenderId: "176353291629",
      appId: "1:176353291629:web:de680e1dcc07b8a1c6be64",
      measurementId: "G-ZP0W1EPL62"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ============ Modal Functions (Global) ============
    window.showModal = function(type) {
      let iconSrc = '';
      let title = '';
      let content = '';

      if (type === 'terms') {
        iconSrc = 'https://i.postimg.cc/br1LGrD9/ei-1770987817459-removebg-preview.png';
        title = 'ข้อกำหนดการใช้งาน';
        content = `
          <p>การใช้งานแอปพลิเคชันนี้อยู่ภายใต้เงื่อนไขดังต่อไปนี้:</p>
          <ul class="list-disc pl-6 mt-4 space-y-2 text-left mx-auto max-w-md text-sm">
            <li>ห้ามใช้แอปเพื่อวัตถุประสงค์ที่ผิดกฎหมาย</li>
            <li>ผู้ใช้ต้องรับผิดชอบต่อข้อมูลที่ป้อนเข้าไปเอง</li>
            <li>เราขอสงวนสิทธิ์ในการระงับหรือยกเลิกการใช้งานหากพบการกระทำที่ไม่เหมาะสม</li>
            <li>แอปนี้ให้บริการฟรีและอาจมีการเปลี่ยนแปลงเงื่อนไขโดยไม่ต้องแจ้งล่วงหน้า</li>
          </ul>
        `;
      } else if (type === 'privacy') {
        iconSrc = 'https://i.postimg.cc/T1nQy1Lm/technology-safety-internet-privacy-protection-secure-security-icon-231797.png';
        title = 'นโยบายความเป็นส่วนตัว';
        content = `
          <p>เราให้ความสำคัญกับความเป็นส่วนตัวของผู้ใช้เป็นอย่างยิ่ง</p>
          <ul class="list-disc pl-6 mt-4 space-y-2 text-left mx-auto max-w-md text-sm">
            <li>ข้อมูลส่วนตัวทั้งหมดจะถูกเก็บรักษาอย่างปลอดภัย</li>
            <li>เราไม่ขายหรือเปิดเผยข้อมูลให้บุคคลที่สามโดยไม่ได้รับอนุญาต</li>
            <li>คุณสามารถติดต่อเราเพื่อขอเข้าถึงหรือลบข้อมูลส่วนตัวได้ตลอดเวลา</li>
          </ul>
        `;
      }

      const modal = document.getElementById('modal');
      const modalIcon = document.getElementById('modal-icon');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');

      modalIcon.src = iconSrc;
      modalIcon.alt = title;
      modalTitle.textContent = title;
      modalBody.innerHTML = content;
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    };

    window.closeModal = function(e) {
      const modal = document.getElementById('modal');
      if (!e || e.target === modal || e.target.classList.contains('close-btn')) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }
    };

    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('modal');
      if (e.key === 'Escape' && modal.classList.contains('show')) {
        window.closeModal();
      }
    });

    // ============ Dark Mode ============
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');

    function setTheme(isDark) {
      document.documentElement.classList.toggle('dark', isDark);
      themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      setTheme(true);
    } else {
      setTheme(false);
    }

    themeToggle.addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));

    // ============ Background Slider ============
    const backgrounds = document.querySelectorAll('.bg-slider');
    let currentIndex = 0;
    
    function showNextBackground() {
      backgrounds[currentIndex].classList.remove('active');
      currentIndex = (currentIndex + 1) % backgrounds.length;
      backgrounds[currentIndex].classList.add('active');
    }
    
    setInterval(showNextBackground, 5000);

    // ============ Toggle Password ============
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    togglePassword.addEventListener('click', () => {
      const type = passwordInput.type === 'password' ? 'text' : 'password';
      passwordInput.type = type;
      togglePassword.textContent = type === 'password' ? 'visibility' : 'visibility_off';
    });

    toggleConfirmPassword.addEventListener('click', () => {
      const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
      confirmPasswordInput.type = type;
      toggleConfirmPassword.textContent = type === 'password' ? 'visibility' : 'visibility_off';
    });

    // ============ Password Strength ============
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    
    function checkPasswordStrength(password) {
      let strength = 0;
      const hasLower = /[a-z]/.test(password);
      const hasUpper = /[A-Z]/.test(password);
      const hasNumber = /\d/.test(password);
      const hasSpecial = /[@!#$%^&*]/.test(password);
      const hasLength = password.length >= 8;
      
      if (hasLength) strength++;
      if (hasLower) strength++;
      if (hasUpper) strength++;
      if (hasNumber) strength++;
      if (hasSpecial) strength++;
      
      return { strength, hasLower, hasUpper, hasNumber, hasSpecial, hasLength };
    }

    passwordInput.addEventListener('input', () => {
      const password = passwordInput.value;
      const result = checkPasswordStrength(password);
      
      // ล้างข้อมูลเก่า
      strengthBar.className = 'strength-bar';
      strengthText.textContent = '';
      
      if (password.length > 0) {
        // แสดงข้อความเตือน
        if (result.strength <= 2) {
          strengthBar.classList.add('weak');
          strengthText.className = 'strength-text weak';
          strengthText.textContent = '⚠️ อ่อน - ต้องเพิ่มตัวพิมพ์ใหญ่, ตัวเลข และอักขระพิเศษ';
        } else if (result.strength <= 3) {
          strengthBar.classList.add('medium');
          strengthText.className = 'strength-text medium';
          strengthText.textContent = '⚡ ปานกลาง - ดีขึ้นแล้ว!';
        } else if (result.strength >= 4) {
          strengthBar.classList.add('strong');
          strengthText.className = 'strength-text strong';
          strengthText.textContent = '✅ แข็งแรง - รหัสผ่านดีมาก!';
        }
      } else {
        // ซ่อนข้อความเมื่อไม่มีข้อมูล
        strengthText.className = 'strength-text';
      }
    });

    // ============ Profile Photo Upload ============
    const profilePhotoInput = document.getElementById('profilePhoto');
    const profilePreview = document.getElementById('profilePreview');

    profilePhotoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          window.notificationManager.error('ไฟล์รูปภาพใหญ่เกินไป (ต้องไม่เกิน 5MB)', 4000);
          profilePhotoInput.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
          profilePreview.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // ============ Form Validation ============
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');

    const fields = {
      username: { el: document.getElementById('username'), error: document.getElementById('usernameError') },
      email: { el: document.getElementById('email'), error: document.getElementById('emailError') },
      password: { el: document.getElementById('password'), error: document.getElementById('passwordError') },
      confirmPassword: { el: document.getElementById('confirmPassword'), error: document.getElementById('confirmPasswordError') },
      terms: { el: document.getElementById('terms'), error: document.getElementById('termsError') }
    };

    function validateRegister() {
      let valid = true;

      if (!window.InputValidator.validateUsername(fields.username.el.value)) {
        fields.username.error.style.display = 'block';
        fields.username.el.classList.add('error');
        valid = false;
      } else {
        fields.username.error.style.display = 'none';
        fields.username.el.classList.remove('error');
      }

      if (!window.InputValidator.validateEmail(fields.email.el.value)) {
        fields.email.error.style.display = 'block';
        fields.email.el.classList.add('error');
        valid = false;
      } else {
        fields.email.error.style.display = 'none';
        fields.email.el.classList.remove('error');
      }

      if (!window.InputValidator.validatePassword(fields.password.el.value)) {
        fields.password.error.style.display = 'block';
        fields.password.el.classList.add('error');
        valid = false;
      } else {
        fields.password.error.style.display = 'none';
        fields.password.el.classList.remove('error');
      }

      if (!window.InputValidator.validatePasswordMatch(fields.password.el.value, fields.confirmPassword.el.value)) {
        fields.confirmPassword.error.style.display = 'block';
        fields.confirmPassword.el.classList.add('error');
        valid = false;
      } else {
        fields.confirmPassword.error.style.display = 'none';
        fields.confirmPassword.el.classList.remove('error');
      }

      if (!fields.terms.el.checked) {
        fields.terms.error.style.display = 'block';
        valid = false;
      } else {
        fields.terms.error.style.display = 'none';
      }

      const emailValue = fields.email.el.value.trim();
      if (emailValue && valid) {
        const limitCheck = window.signupRateLimiter.checkLimit(emailValue);
        valid = limitCheck.allowed;
      }

      registerBtn.disabled = !valid;
      return valid;
    }

    Object.values(fields).forEach(f => {
      if (f.el.tagName === 'INPUT') {
        f.el.addEventListener('input', validateRegister);
      }
      f.el.addEventListener('change', validateRegister);
    });

    validateRegister();

    // ============ Register Submit ============
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (registerBtn.disabled) return;

      const emailValue = fields.email.el.value.trim();
      
      const limitCheck = window.signupRateLimiter.checkLimit(emailValue);
      if (!limitCheck.allowed) {
        window.notificationManager.error(`สมัครสมาชิกหลายครั้งเกินไป กรุณารอ ${limitCheck.remainingTime} วินาที`, 5000);
        return;
      }

      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');

      try {
        registerBtn.disabled = true;
        btnText.textContent = 'กำลังสมัครสมาชิก...';
        btnSpinner.classList.remove('hidden');

        const usernameValue = window.InputValidator.sanitizeString(fields.username.el.value);
        const passwordValue = fields.password.el.value;

        const csrfToken = window.csrfTokenManager.getToken();

        const userCredential = await createUserWithEmailAndPassword(auth, emailValue, passwordValue);
        const user = userCredential.user;

        let photoURL = null;

        const photoFile = profilePhotoInput.files[0];
        if (photoFile) {
          const maxSize = 5 * 1024 * 1024;
          if (photoFile.size > maxSize) {
            throw new Error('ไฟล์รูปภาพใหญ่เกินไป (ต้องไม่เกิน 5MB)');
          }

          try {
            const oldRef = ref(storage, `profile-photos/${user.uid}`);
            await deleteObject(oldRef);
          } catch (err) {
            // Old photo doesn't exist, skip
          }

          const storageRef = ref(storage, `profile-photos/${user.uid}`);
          await uploadBytes(storageRef, photoFile);
          photoURL = await getDownloadURL(storageRef);
        }

        await updateProfile(user, {
          displayName: usernameValue,
          photoURL: photoURL
        });

        await setDoc(doc(db, "users", user.uid), {
          uid: user.uid,
          email: emailValue,
          username: usernameValue,
          photoURL: photoURL || null,
          createdAt: new Date(),
          provider: "email"
        });

        window.signupRateLimiter.reset(emailValue);

        window.notificationManager.success('สมัครสมาชิกสำเร็จ!', 3000);
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1500);
      } catch (error) {
        registerBtn.disabled = false;
        btnText.textContent = 'สมัครสมาชิก';
        btnSpinner.classList.add('hidden');

        let errorMessage = 'สมัครสมาชิกล้มเหลว';

        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'อีเมลนี้ถูกใช้งานแล้ว';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'รหัสผ่านไม่แข็งแรงพอ';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'เกิดปัญหาการเชื่อมต่อ กรุณาลองใหม่';
        } else if (error.message) {
          errorMessage = error.message;
        }

        window.notificationManager.error(errorMessage, 5000);
        console.error('Register error:', error);
      }
    });

    // ============ Google Signup ============
    document.getElementById('googleSignup').addEventListener('click', async () => {
      const googleBtnText = document.getElementById('googleBtnText');
      const googleSpinner = document.getElementById('googleSpinner');

      try {
        const provider = new GoogleAuthProvider();
        googleBtnText.textContent = 'กำลังสมัคร...';
        googleSpinner.classList.remove('hidden');

        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);

        if (!userDoc.exists()) {
          await setDoc(userDocRef, {
            uid: user.uid,
            email: user.email,
            username: user.displayName || "Google User",
            photoURL: user.photoURL || null,
            createdAt: new Date(),
            provider: "google"
          });
        }

        window.notificationManager.success('สมัครด้วย Google สำเร็จ!', 3000);
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1500);
      } catch (error) {
        googleBtnText.textContent = 'สมัครด้วย Google';
        googleSpinner.classList.add('hidden');

        let errorMessage = 'Google Sign-up ล้มเหลว';

        if (error.code === 'auth/popup-blocked') {
          errorMessage = 'ป๊อปอัพถูกบล็อก กรุณาอนุญาตให้แสดงป๊อปอัพ';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'เกิดปัญหาการเชื่อมต่อ กรุณาลองใหม่';
        } else if (error.code === 'auth/cancelled-popup-request') {
          return;
        }

        window.notificationManager.error(errorMessage, 5000);
        console.error('Google signup error:', error);
      }
    });

    window.addEventListener('load', () => {
      window.csrfTokenManager.getToken();
    });
  </script>
</body>
</html>
