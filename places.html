<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ค้นหาสถานที่ - จัดการเวลาเที่ยว-ค่าใช้จ่าย</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#6366f1",
                        danger: "#ef4444",
                        success: "#22c55e",
                        warning: "#f59e0b",
                        "background-light": "#f8fafc",
                        "background-dark": "#020617",
                    },
                    fontFamily: {
                        sans: ["Kanit", "Inter", "sans-serif"],
                        display: ["Outfit", "Kanit", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { border: 5px solid #FFF; border-bottom-color: #6366f1; border-radius: 50%; width: 48px; height: 48px; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown-menu { transform-origin: top right; animation: dropdownIn 0.2s ease-out; }
        @keyframes dropdownIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .modal-overlay { animation: fadeInOverlay 0.3s ease-out; }
        @keyframes fadeInOverlay { 0% { opacity: 0; } 100% { opacity: 1; } }
        .modal-content { animation: slideUpModal 0.3s ease-out; }
        @keyframes slideUpModal { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .scroll-btn-enter-active { animation: scaleIn 0.3s ease-out; }
        .scroll-btn-leave-active { animation: scaleOut 0.2s ease-in; }
        @keyframes scaleIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes scaleOut { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.5); opacity: 0; } }
        
        /* สำคัญ: ให้สามารถเลื่อนได้ */
        html, body { height: 100%; overflow: hidden; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .main-content { height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .search-section { flex-shrink: 0; }
        .places-container { flex: 1; overflow-y: auto; overflow-x: hidden; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-sans transition-colors duration-300">
    <div id="app" class="flex flex-col h-screen">
        <!-- Toast Notification -->
        <div v-if="toast.show" class="fixed top-24 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300">
            <div class="flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl min-w-[320px] justify-center backdrop-blur-md"
                 :class="getToastClass()">
                <span class="material-symbols-outlined text-white">{{ toast.icon }}</span>
                <span class="font-medium text-white">{{ toast.message }}</span>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div v-if="loading" class="fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl flex flex-col items-center">
                <div class="relative mb-4">
                    <div class="w-14 h-14 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
                </div>
                <p class="text-slate-600 dark:text-slate-300 font-medium">{{ loadingText }}</p>
            </div>
        </div>

        <!-- Error Modal -->
        <div v-if="errorModal.show" class="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm flex items-center justify-center modal-overlay">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl max-w-md modal-content max-h-[80vh] overflow-y-auto">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-danger text-xl">error</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ errorModal.title }}</h3>
                </div>
                <p class="text-slate-600 dark:text-slate-400 mb-4 text-sm">{{ errorModal.message }}</p>
                <div v-if="errorModal.details" class="bg-slate-100 dark:bg-slate-800 p-3 rounded-lg mb-6 text-xs text-slate-600 dark:text-slate-300 font-mono overflow-auto max-h-32">
                    {{ errorModal.details }}
                </div>
                <div class="flex gap-3 justify-end">
                    <button @click="closeErrorModal" class="px-6 py-2.5 rounded-xl bg-primary text-white font-medium hover:bg-primary-700 transition-colors">
                        ปิด
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Modal -->
        <div v-if="filterModal.show" class="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm flex items-center justify-center modal-overlay">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl max-w-sm modal-content">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">tune</span>
                        ตัวกรองและการเรียงลำดับ
                    </h3>
                    <button @click="filterModal.show = false" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Sort Options -->
                    <div>
                        <label class="text-sm font-bold text-slate-800 dark:text-white block mb-3">เรียงลำดับ</label>
                        <div class="space-y-2">
                            <button @click="sortBy = 'relevance'" :class="['w-full p-3 rounded-xl border-2 text-left transition-all', sortBy === 'relevance' ? 'border-primary bg-primary/10 text-primary' : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:border-primary']">
                                <span class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-base">search</span>
                                    <span>ความเกี่ยวข้อง</span>
                                </span>
                            </button>
                            <button @click="sortBy = 'rating'" :class="['w-full p-3 rounded-xl border-2 text-left transition-all', sortBy === 'rating' ? 'border-primary bg-primary/10 text-primary' : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:border-primary']">
                                <span class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-base">star</span>
                                    <span>คะแนนสูงสุด</span>
                                </span>
                            </button>
                            <button @click="sortBy = 'reviews'" :class="['w-full p-3 rounded-xl border-2 text-left transition-all', sortBy === 'reviews' ? 'border-primary bg-primary/10 text-primary' : 'border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:border-primary']">
                                <span class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-base">comment</span>
                                    <span>จำนวนรีวิวมากสุด</span>
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Rating Filter -->
                    <div>
                        <label class="text-sm font-bold text-slate-800 dark:text-white block mb-3">คะแนนต่ำสุด: <span class="text-primary">{{ minRating.toFixed(1) }}</span> ⭐</label>
                        <input v-model.number="minRating" type="range" min="0" max="5" step="0.5" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary">
                        <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400 mt-2">
                            <span>0.0 ⭐</span>
                            <span>5.0 ⭐</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4 border-t border-slate-200 dark:border-slate-700">
                        <button @click="clearFilters" class="flex-1 px-4 py-3 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">refresh</span>
                            ล้าง
                        </button>
                        <button @click="filterModal.show = false" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">check_circle</span>
                            ตกลง
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collections Modal -->
        <div v-if="collectionsModal.show" class="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm flex items-center justify-center modal-overlay">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl max-w-md modal-content max-h-[80vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">folder</span>
                        การรวมกลุ่ม
                    </h3>
                    <button @click="collectionsModal.show = false" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="space-y-3 mb-6">
                    <div v-for="collection in collections" :key="collection.id" class="p-4 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer hover:border-primary transition-colors group" @click="selectCollection(collection)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-lg">folder_open</span>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 dark:text-white">{{ collection.name }}</h4>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">{{ collection.places.length }} สถานที่</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors">chevron_right</span>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-200 dark:border-slate-700 pt-6">
                    <h4 class="font-bold text-slate-800 dark:text-white mb-3">สร้างการรวมกลุ่มใหม่</h4>
                    <input v-model="newCollectionName" type="text" placeholder="ชื่อการรวมกลุ่ม (เช่น ร้านกาแฟที่ดี)" class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-white placeholder-slate-400 mb-3">
                    <button @click="createNewCollection" :disabled="!newCollectionName.trim()" class="w-full px-4 py-2.5 bg-primary text-white rounded-xl font-medium hover:bg-primary-700 disabled:bg-slate-400 transition-colors">
                        <span class="material-symbols-outlined mr-2">add</span> สร้างการรวมกลุ่ม
                    </button>
                </div>
            </div>
        </div>

        <!-- Notes Modal -->
        <div v-if="notesModal.show" class="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm flex items-center justify-center modal-overlay">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-2xl max-w-md modal-content">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">{{ notesModal.placeName }}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">เพิ่มหมายเหตุส่วนตัว</p>
                    </div>
                    <button @click="notesModal.show = false" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <textarea v-model="notesModal.content" placeholder="เขียนหมายเหตุของคุณ..." class="w-full h-32 px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-white placeholder-slate-400 resize-none focus:ring-2 focus:ring-primary focus:border-transparent mb-4"></textarea>

                <div class="flex gap-3">
                    <button @click="notesModal.show = false" class="flex-1 px-4 py-2.5 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white rounded-xl font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                        ยกเลิก
                    </button>
                    <button @click="saveNote" class="flex-1 px-4 py-2.5 bg-primary text-white rounded-xl font-medium hover:bg-primary-700 transition-colors">
                        บันทึก
                    </button>
                </div>
            </div>
        </div>

        <header class="fixed top-0 w-full z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
            <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button @click="goToDashboard" class="p-2.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">arrow_back</span>
                    </button>
                    
                    <div>
                        <img src="https://i.postimg.cc/d3Jnyv2F/11zon-cropped.png" alt="Logo" class="w-10 h-10 rounded-full">
                    </div>
                    
                    <div class="hidden md:block">
                        <span class="font-display text-xl font-extrabold tracking-tight block leading-tight">ค้นหาสถานที่</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button v-if="hasSearched" @click="filterModal.show = true" class="p-2.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors relative" title="ตัวกรอง">
                        <span class="material-symbols-outlined text-slate-600 dark:text-slate-300">tune</span>
                        <span v-if="sortBy !== 'relevance' || minRating > 0" class="absolute top-1 right-1 w-2 h-2 bg-primary rounded-full"></span>
                    </button>

                    <button class="p-2.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors flex items-center justify-center" @click="toggleDarkMode" title="Dark Mode">
                        <span class="material-symbols-outlined text-slate-600 dark:text-yellow-400">{{ isDark ? 'light_mode' : 'dark_mode' }}</span>
                    </button>
                   
                    <button @click="toggleMobileFav" class="md:hidden relative w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                        <span class="material-symbols-outlined">favorite</span>
                        <span v-if="favorites.length > 0" class="absolute -top-1 -right-1 bg-danger text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full ring-2 ring-white dark:ring-slate-900">{{ favorites.length }}</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="main-content flex-1">
            <div class="flex-1 flex overflow-hidden pt-16 md:pt-20">
                <main class="flex-1 flex flex-col overflow-hidden relative w-full">
                    <!-- Search Bar Section -->
                    <div class="search-section px-4 py-4 md:px-6 md:py-6 bg-background-light dark:bg-background-dark z-20 border-b border-slate-200 dark:border-slate-800">
                        <div class="max-w-4xl mx-auto w-full">
                            <div class="flex flex-col gap-3">
                                <div class="flex flex-col md:flex-row gap-3">
                                    <div class="flex-1 bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center p-2">
                                        <span class="material-symbols-outlined text-slate-400 ml-2">search</span>
                                        <input type="text" v-model="searchQuery" class="w-full bg-transparent border-none focus:ring-0 text-slate-700 dark:text-slate-200 placeholder-slate-400" placeholder="ค้นหา (เช่น ร้านกาแฟ, ปั๊มน้ำมัน)" @keyup.enter="performSearch">
                                    </div>
                                    <div class="flex-[0.5] bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center p-2">
                                        <span class="material-symbols-outlined text-danger ml-2">location_on</span>
                                        <input type="text" v-model="locationQuery" class="w-full bg-transparent border-none focus:ring-0 text-slate-700 dark:text-slate-200 placeholder-slate-400 text-sm" placeholder="จังหวัด (เช่น ภูเก็ต)" @keyup.enter="performSearch">
                                    </div>
                                    <button @click="performSearch" :disabled="isSearching" class="bg-primary hover:bg-primary-700 disabled:bg-slate-400 text-white px-6 py-3 rounded-2xl font-medium shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2 min-w-[120px] flex-shrink-0">
                                        <span v-if="!isSearching" class="material-symbols-outlined">search</span>
                                        <div v-if="isSearching" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                        <span>{{ isSearching ? 'กำลังค้นหา...' : 'ค้นหา' }}</span>
                                    </button>
                                </div>

                                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                    <button @click="quickSearch('ร้านอาหาร')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-full text-sm text-slate-600 dark:text-slate-300 hover:border-primary hover:text-primary transition-all whitespace-nowrap flex-shrink-0">
                                        <span class="material-symbols-outlined text-orange-400 text-lg">restaurant</span> ร้านอาหาร
                                    </button>
                                    <button @click="quickSearch('คาเฟ่')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-full text-sm text-slate-600 dark:text-slate-300 hover:border-primary hover:text-primary transition-all whitespace-nowrap flex-shrink-0">
                                        <span class="material-symbols-outlined text-amber-700 text-lg">coffee</span> คาเฟ่
                                    </button>
                                    <button @click="quickSearch('โรงแรม')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-full text-sm text-slate-600 dark:text-slate-300 hover:border-primary hover:text-primary transition-all whitespace-nowrap flex-shrink-0">
                                        <span class="material-symbols-outlined text-blue-400 text-lg">hotel</span> โรงแรม
                                    </button>
                                    <button @click="quickSearch('สถานที่ท่องเที่ยว')" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-full text-sm text-slate-600 dark:text-slate-300 hover:border-primary hover:text-primary transition-all whitespace-nowrap flex-shrink-0">
                                        <span class="material-symbols-outlined text-green-500 text-lg">photo_camera</span> ท่องเที่ยว
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Places List Section - Scrollable -->
                    <div class="places-container flex-1 overflow-y-auto px-4 md:px-6 relative" id="mainContainer">
                        <div class="max-w-7xl mx-auto">
                            <div v-if="!hasSearched && !isSearching" class="flex flex-col items-center justify-center h-full min-h-[400px] text-center">
                                <div class="w-24 h-24 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                                    <span class="material-symbols-outlined text-5xl text-primary">explore</span>
                                </div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white font-display">ค้นหาสถานที่ใหม่ๆ</h2>
                                <p class="text-slate-500 dark:text-slate-400 mt-2 max-w-md">ค้นหาร้านอาหาร ที่พัก และสถานที่ท่องเที่ยว พร้อมบันทึกรายการโปรด</p>
                            </div>

                            <div v-if="isSearching" class="flex flex-col items-center justify-center h-full min-h-[400px]">
                                <span class="loader mb-6 border-slate-200 dark:border-slate-700 border-b-primary"></span>
                                <p class="text-slate-600 dark:text-slate-300 font-medium animate-pulse">กำลังค้นหาข้อมูล...</p>
                            </div>

                            <div v-if="hasSearched && !isSearching" class="py-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div>
                                        <h2 class="text-xl font-bold text-slate-800 dark:text-white font-display">ผลการค้นหา: <span class="text-primary">"{{ lastSearchQuery }}"</span></h2>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">แสดง {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, allSearchResults.length) }} จาก {{ allSearchResults.length }} รายการ</p>
                                    </div>
                                    <span class="text-xs font-medium text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-900 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700">{{ allSearchResults.length }} รายการ</span>
                                </div>
                                
                                <div v-if="allSearchResults.length === 0" class="text-center py-10">
                                    <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span class="material-symbols-outlined text-4xl text-slate-400">search_off</span>
                                    </div>
                                    <p class="text-slate-500 dark:text-slate-400">ไม่พบสถานที่ที่ค้นหา</p>
                                </div>
                                
                                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
                                    <div v-for="(place, index) in searchResults" :key="index" class="bg-white dark:bg-slate-900 rounded-3xl overflow-hidden hover:shadow-lg group border border-slate-200 dark:border-slate-800 flex flex-col h-full transition-all">
                                        <div class="relative h-48 overflow-hidden bg-slate-100 dark:bg-slate-800">
                                            <img :src="place.thumbnail || defaultImage" @error="imageError($event)" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60"></div>
                                            <div class="absolute top-3 right-3 flex gap-2">
                                                <button @click="toggleFavorite(place, index)" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/30 flex items-center justify-center hover:bg-white transition-all">
                                                    <span class="material-symbols-outlined text-xl" :class="isFavorite(place) ? 'text-danger fill-current' : 'text-white'">favorite</span>
                                                </button>
                                                <button @click="openCollectionsModal(place)" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/30 flex items-center justify-center hover:bg-white transition-all">
                                                    <span class="material-symbols-outlined text-xl text-white">folder_open</span>
                                                </button>
                                            </div>
                                            <div v-if="place.rating" class="absolute bottom-3 left-3 flex items-center gap-1 bg-black/40 backdrop-blur-md px-2.5 py-1 rounded-lg">
                                                <span class="material-symbols-outlined text-warning text-sm">star</span>
                                                <span class="text-white text-xs font-bold">{{ place.rating }}</span>
                                            </div>
                                        </div>
                                        <a :href="`https://www.google.com/search?q=${encodeURIComponent(place.title + ' ' + (place.address || ''))}`" target="_blank" class="p-5 flex-1 flex flex-col cursor-pointer">
                                            <h3 class="font-bold text-lg text-slate-800 dark:text-white line-clamp-1 group-hover:text-primary transition-colors">{{ place.title }}</h3>
                                            <div class="flex flex-wrap gap-2 mb-4 mt-2">
                                                <span class="px-2.5 py-0.5 rounded-md bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs">{{ place.type || 'สถานที่' }}</span>
                                            </div>
                                            <div class="mt-auto flex items-start gap-2 pt-4 border-t border-slate-100 dark:border-slate-800">
                                                <span class="material-symbols-outlined text-slate-400 text-sm mt-0.5">location_on</span>
                                                <p class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">{{ place.address || 'ไม่มีข้อมูลที่อยู่' }}</p>
                                            </div>
                                        </a>
                                        <div class="px-5 pb-5 flex gap-2 border-t border-slate-100 dark:border-slate-800 pt-4">
                                            <button @click="openNotesModal(place)" class="flex-1 px-3 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2">
                                                <span class="material-symbols-outlined text-base">note</span> หมายเหตุ
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="allSearchResults.length > itemsPerPage" class="flex items-center justify-center gap-4 pb-6">
                                    <button @click="previousPage" :disabled="currentPage === 1" class="px-6 py-3 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-medium hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                        <span class="material-symbols-outlined mr-2">chevron_left</span> หน้าก่อนหน้า
                                    </button>
                                    <div class="flex items-center gap-2">
                                        <span v-for="page in totalPages" :key="page" @click="goToPage(page)" :class="['w-10 h-10 flex items-center justify-center rounded-lg font-medium cursor-pointer transition-colors', page === currentPage ? 'bg-primary text-white' : 'border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800']">
                                            {{ page }}
                                        </span>
                                    </div>
                                    <button @click="nextPage" :disabled="currentPage === totalPages" class="px-6 py-3 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-medium hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                        หน้าถัดไป <span class="material-symbols-outlined ml-2">chevron_right</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Scroll Buttons - Fixed Position -->
                        <transition name="scroll-btn">
                            <div v-if="showScrollButtons" class="fixed right-6 bottom-32 z-40 flex flex-col gap-3">
                                <button @click="scrollUp" class="w-12 h-12 bg-primary hover:bg-primary-700 text-white rounded-full flex items-center justify-center shadow-lg hover:shadow-xl transition-all transform hover:scale-110" title="เลื่อนขึ้น">
                                    <span class="material-symbols-outlined text-2xl">expand_less</span>
                                </button>
                                <button @click="scrollDown" class="w-12 h-12 bg-primary hover:bg-primary-700 text-white rounded-full flex items-center justify-center shadow-lg hover:shadow-xl transition-all transform hover:scale-110" title="เลื่อนลง">
                                    <span class="material-symbols-outlined text-2xl">expand_more</span>
                                </button>
                            </div>
                        </transition>
                    </div>
                </main>

                <!-- Desktop Favorites Sidebar -->
                <aside class="w-96 bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 hidden md:flex flex-col z-20 shadow-2xl overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center flex-shrink-0">
                        <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2 text-lg font-display">
                            <span class="material-symbols-outlined text-danger">favorite</span> รายการโปรด
                        </h3>
                        <span class="bg-primary/10 text-primary text-xs font-bold px-2.5 py-1 rounded-lg">{{ favorites.length }}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-950/50">
                        <div v-if="!isLoggedIn" class="flex flex-col items-center justify-center h-40 text-slate-400 dark:text-slate-500 text-sm gap-2">
                            <span class="material-symbols-outlined text-3xl opacity-50">lock</span>
                            กรุณาเข้าสู่ระบบเพื่อดูรายการโปรด
                        </div>
                        <div v-else-if="favorites.length === 0" class="flex flex-col items-center justify-center h-40 text-slate-400 dark:text-slate-500 text-sm gap-2">
                            <span class="material-symbols-outlined text-3xl opacity-50">heart_broken</span>
                            ยังไม่มีรายการโปรด
                        </div>
                        <div v-else v-for="fav in favorites" :key="fav.id" class="bg-white dark:bg-slate-900 p-3 rounded-2xl border border-slate-200 dark:border-slate-800 hover:border-primary/50 transition-all group relative flex gap-3 shadow-sm">
                            <img :src="fav.thumbnail || defaultImage" @error="imageError($event)" class="w-16 h-16 rounded-xl object-cover bg-slate-100 dark:bg-slate-800 flex-shrink-0">
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <h4 class="font-bold text-sm text-slate-800 dark:text-white truncate pr-6 group-hover:text-primary transition-colors">{{ fav.title }}</h4>
                                <div class="flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    <span class="material-symbols-outlined text-[10px] text-warning">star</span>
                                    {{ fav.rating || '-' }} • {{ fav.type || 'สถานที่' }}
                                </div>
                            </div>
                            <button @click="removeFavorite(fav.id)" class="absolute top-2 right-2 w-7 h-7 flex items-center justify-center rounded-full text-slate-300 hover:text-danger hover:bg-red-50 dark:hover:bg-red-900/20 transition-all opacity-0 group-hover:opacity-100">
                                <span class="material-symbols-outlined text-base">delete</span>
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Mobile Favorites Sheet -->
        <div v-if="mobileFavOpen" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm" @click="toggleMobileFav"></div>
        <div class="fixed bottom-0 left-0 right-0 z-[70] bg-white dark:bg-slate-900 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform transition-transform duration-300 h-[85vh] flex flex-col md:hidden border-t border-slate-200 dark:border-slate-800"
             :class="mobileFavOpen ? 'translate-y-0' : 'translate-y-full'">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mt-4 mb-2"></div>
            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-xl text-slate-800 dark:text-white flex items-center gap-2">รายการโปรด <span class="text-sm font-normal text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-md">({{ favorites.length }})</span></h3>
                <button @click="toggleMobileFav" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 flex items-center justify-center text-slate-600 dark:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-950/50">
                <div v-if="!isLoggedIn" class="flex flex-col items-center justify-center py-10 opacity-50 gap-2">
                    <span class="material-symbols-outlined text-3xl">lock</span>
                    <p class="text-sm">เข้าสู่ระบบเพื่อดูรายการโปรด</p>
                </div>
                <div v-else-if="favorites.length === 0" class="flex flex-col items-center justify-center py-10 opacity-50 gap-2">
                    <span class="material-symbols-outlined text-3xl">heart_broken</span>
                    <p class="text-sm">ยังไม่มีรายการโปรด</p>
                </div>
                <div v-else v-for="fav in favorites" :key="fav.id" class="bg-white dark:bg-slate-900 p-3 rounded-2xl border border-slate-200 dark:border-slate-800 flex gap-3 shadow-sm">
                    <img :src="fav.thumbnail || defaultImage" @error="imageError($event)" class="w-16 h-16 rounded-xl object-cover bg-slate-100 dark:bg-slate-800 flex-shrink-0">
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <h4 class="font-bold text-sm text-slate-800 dark:text-white truncate">{{ fav.title }}</h4>
                        <div class="flex items-center gap-1 text-xs text-slate-500 dark:text-slate-400 mt-1">
                            <span class="material-symbols-outlined text-[10px] text-warning">star</span>
                            {{ fav.rating || '-' }} • {{ fav.type || 'สถานที่' }}
                        </div>
                    </div>
                    <button @click="removeFavorite(fav.id)" class="w-7 h-7 flex items-center justify-center rounded-full text-slate-300 hover:text-danger hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        const CACHE_KEYS = {
            SEARCH_RESULTS: 'searchResults_',
            COLLECTIONS: 'collections',
            NOTES: 'notes',
            FAVORITES: 'favorites_meta'
        };

        const CACHE_EXPIRY = 24 * 60 * 60 * 1000;

        class CacheManager {
            static generateKey(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            static set(key, data, expiry = CACHE_EXPIRY) {
                const hashedKey = CACHE_KEYS.SEARCH_RESULTS + this.generateKey(key);
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(hashedKey, JSON.stringify(cacheData));
            }

            static get(key) {
                const hashedKey = CACHE_KEYS.SEARCH_RESULTS + this.generateKey(key);
                const cached = localStorage.getItem(hashedKey);
                if (!cached) return null;
                
                try {
                    const cacheData = JSON.parse(cached);
                    const isExpired = Date.now() - cacheData.timestamp > CACHE_EXPIRY;
                    
                    if (isExpired) {
                        localStorage.removeItem(hashedKey);
                        return null;
                    }
                    return cacheData.data;
                } catch (error) {
                    return null;
                }
            }

            static clear() {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('searchResults_') || key.startsWith('collections') || key.startsWith('notes')) {
                        localStorage.removeItem(key);
                    }
                });
            }
        }

        createApp({
            data() {
                return {
                    isDark: false,
                    isLoggedIn: false,
                    loading: false,
                    loadingText: 'กำลังโหลด...',
                    userDisplayName: 'Guest User',
                    userEmail: '',
                    userPhotoURL: null,
                    searchQuery: '',
                    locationQuery: '',
                    lastSearchQuery: '',
                    isSearching: false,
                    hasSearched: false,
                    allSearchResults: [],
                    searchResults: [],
                    favorites: [],
                    collections: [],
                    profileOpen: false,
                    mobileFavOpen: false,
                    showScrollButtons: false,
                    toast: { show: false, message: '', type: 'info', icon: 'info' },
                    errorModal: { show: false, title: '', message: '', details: '' },
                    filterModal: { show: false },
                    collectionsModal: { show: false, selectedPlace: null },
                    notesModal: { show: false, placeName: '', content: '', placeId: null },
                    newCollectionName: '',
                    API_KEY: '564c5f87d4737579d5e26d94c5343be51202fb9a96c9976e9b9a68816eb7ebe4',
                    PROXY_URL: 'https://corsproxy.io/?',
                    defaultImage: 'https://images.unsplash.com/photo-1569336415962-a4bd9f69cd83?w=600',
                    subscription: null,
                    sortBy: 'relevance',
                    minRating: 0,
                    currentPage: 1,
                    itemsPerPage: 20,
                    notes: {},
                    retryAttempts: 0,
                    maxRetryAttempts: 3
                }
            },
            computed: {
                totalPages() {
                    return Math.ceil(this.allSearchResults.length / this.itemsPerPage);
                }
            },
            watch: {
                allSearchResults: {
                    handler() {
                        this.currentPage = 1;
                        this.updateSearchResults();
                    }
                },
                sortBy: {
                    handler() {
                        this.updateSearchResults();
                    }
                },
                minRating: {
                    handler() {
                        this.updateSearchResults();
                    }
                }
            },
            mounted() {
                this.detectSystemTheme();
                this.initializeAuth();
                this.loadCollectionsFromStorage();
                this.loadNotesFromStorage();
                document.addEventListener('click', this.handleClickOutside);
                
                const container = document.getElementById('mainContainer');
                if (container) {
                    container.addEventListener('scroll', this.handleScroll);
                }
            },
            beforeUnmount() {
                document.removeEventListener('click', this.handleClickOutside);
                const container = document.getElementById('mainContainer');
                if (container) {
                    container.removeEventListener('scroll', this.handleScroll);
                }
                if (this.subscription) this.subscription.unsubscribe();
            },
            methods: {
                handleScroll() {
                    const container = document.getElementById('mainContainer');
                    if (container && this.hasSearched) {
                        this.showScrollButtons = container.scrollTop > 300;
                    }
                },
                scrollUp() {
                    const container = document.getElementById('mainContainer');
                    if (container) {
                        container.scrollBy({
                            top: -300,
                            behavior: 'smooth'
                        });
                    }
                },
                scrollDown() {
                    const container = document.getElementById('mainContainer');
                    if (container) {
                        container.scrollBy({
                            top: 300,
                            behavior: 'smooth'
                        });
                    }
                },
                getToastClass() {
                    const baseClass = 'flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl min-w-[320px] justify-center backdrop-blur-md';
                    if (this.toast.type === 'error') return baseClass + ' bg-red-600';
                    if (this.toast.type === 'success') return baseClass + ' bg-green-600';
                    if (this.toast.type === 'warning') return baseClass + ' bg-amber-600';
                    return baseClass + ' bg-slate-800 dark:bg-slate-900';
                },
                detectSystemTheme() {
                    const savedTheme = localStorage.getItem('theme');
                    this.isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    this.applyTheme();
                },
                applyTheme() {
                    document.documentElement.classList.toggle('dark', this.isDark);
                },
                toggleDarkMode() {
                    this.isDark = !this.isDark;
                    localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
                    this.applyTheme();
                },
                showToast(message, type = 'info') {
                    const icons = { success: 'check_circle', error: 'error', warning: 'warning', info: 'info' };
                    this.toast = { show: true, message, type, icon: icons[type] || 'info' };
                    setTimeout(() => this.toast.show = false, 3000);
                },
                showError(title, message, details = '') {
                    this.errorModal = { show: true, title, message, details };
                },
                closeErrorModal() {
                    this.errorModal.show = false;
                },
                initializeAuth() {
                    firebaseService.onAuthChanged = async (user) => {
                        if (user) {
                            this.isLoggedIn = true;
                            this.userDisplayName = user.displayName || 'ผู้ใช้';
                            this.userEmail = user.email || '';
                            this.userPhotoURL = user.photoURL;
                            await this.loadFavorites();
                            this.setupRealtimeSubscription();
                        } else {
                            this.isLoggedIn = false;
                            this.userDisplayName = 'Guest User';
                            this.userEmail = 'เข้าสู่ระบบเพื่อบันทึกข้อมูล';
                            this.userPhotoURL = null;
                            this.favorites = [];
                        }
                    };
                },
                setupRealtimeSubscription() {
                    this.subscription = supabaseService.subscribeToFavorites((payload) => {
                        this.loadFavorites();
                    });
                },
                async loadFavorites() {
                    try {
                        const result = await supabaseService.getFavorites();
                        if (result.success) {
                            this.favorites = result.data || [];
                        }
                    } catch (error) {
                        this.showToast('ไม่สามารถโหลดรายการโปรดได้', 'error');
                    }
                },
                async toggleFavorite(place, index) {
                    if (!this.isLoggedIn) {
                        this.showToast('กรุณาเข้าสู่ระบบก่อนบันทึก', 'warning');
                        return;
                    }
                    
                    const existingFav = this.favorites.find(f => f.title === place.title);
                    try {
                        if (existingFav) {
                            await supabaseService.removeFavorite(existingFav.id);
                            this.showToast('ลบจากรายการโปรดแล้ว', 'success');
                        } else {
                            const data = {
                                title: place.title || 'Unknown',
                                address: place.address || '',
                                thumbnail: place.thumbnail || this.defaultImage,
                                rating: place.rating || 0,
                                type: place.type || 'Place'
                            };
                            await supabaseService.addFavorite(data);
                            this.showToast('บันทึกรายการโปรดแล้ว', 'success');
                        }
                    } catch (error) {
                        this.showError('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการจัดการรายการโปรด', error.message);
                    }
                },
                isFavorite(place) {
                    return this.favorites.some(f => f.title === place.title);
                },
                async removeFavorite(id) {
                    try {
                        await supabaseService.removeFavorite(id);
                        this.showToast('ลบรายการแล้ว', 'success');
                    } catch (error) {
                        this.showError('ข้อผิดพลาด', 'ไม่สามารถลบรายการโปรดได้', error.message);
                    }
                },
                async performSearch() {
                    const query = this.searchQuery.trim();
                    const location = this.locationQuery.trim();
                    
                    if (!query && !location) {
                        this.showToast('กรุณาระบุคำค้นหา หรือ สถานที่', 'warning');
                        return;
                    }

                    const cacheKeyString = query + location;
                    const cachedResults = CacheManager.get(cacheKeyString);
                    
                    if (cachedResults && cachedResults.length > 0) {
                        this.allSearchResults = cachedResults;
                        this.lastSearchQuery = query + (location ? ' - ' + location : '');
                        this.hasSearched = true;
                        this.showToast('โหลดจากแคชข้อมูล', 'info');
                        this.updateSearchResults();
                        return;
                    }

                    this.isSearching = true;
                    this.retryAttempts = 0;
                    this.lastSearchQuery = query + (location ? ' - ' + location : '');
                    this.hasSearched = true;

                    await this.executeSearch(query, location, cacheKeyString);
                },
                async executeSearch(query, location, cacheKeyString) {
                    const combinedQuery = `${query} ${location}`.trim();
                    
                    const params = new URLSearchParams({
                        engine: "google_maps",
                        q: combinedQuery,
                        google_domain: "google.co.th",
                        hl: "th",
                        type: "search",
                        api_key: this.API_KEY
                    });

                    try {
                        const url = `https://serpapi.com/search.json?${params.toString()}`;
                        const fullUrl = this.PROXY_URL + encodeURIComponent(url);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => {
                            controller.abort();
                        }, 30000);

                        const response = await fetch(fullUrl, {
                            signal: controller.signal,
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                        }

                        const data = await response.json();

                        if (data.error) {
                            throw new Error(`API Error: ${data.error}`);
                        }

                        const results = data.local_results || [];
                        
                        if (results.length === 0) {
                            this.showToast('ไม่พบสถานที่ที่ค้นหา', 'info');
                            this.allSearchResults = [];
                        } else {
                            this.allSearchResults = results;
                            CacheManager.set(cacheKeyString, results);
                            this.showToast(`พบ ${results.length} รายการ`, 'success');
                        }

                    } catch (error) {
                        if (error.name === 'AbortError') {
                            this.showError('หมดเวลา', 'การค้นหาใช้เวลานานเกินไป (30 วินาที)', 'AbortError');
                        } else if (this.retryAttempts < this.maxRetryAttempts) {
                            this.retryAttempts++;
                            this.showToast(`กำลังลองใหม่ (${this.retryAttempts}/${this.maxRetryAttempts})...`, 'warning');
                            await new Promise(resolve => setTimeout(resolve, 3000));
                            await this.executeSearch(query, location, cacheKeyString);
                            return;
                        } else {
                            this.showError(
                                'ข้อผิดพลาดในการค้นหา',
                                'ไม่สามารถค้นหาได้ในขณะนี้ กรุณาลองใหม่ในภายหลัง',
                                error.message
                            );
                            this.allSearchResults = [];
                        }
                    } finally {
                        this.isSearching = false;
                    }
                },
                updateSearchResults() {
                    let filtered = this.allSearchResults.filter(place => {
                        const rating = parseFloat(place.rating) || 0;
                        return rating >= this.minRating;
                    });

                    if (this.sortBy === 'rating') {
                        filtered.sort((a, b) => {
                            const ratingA = parseFloat(a.rating) || 0;
                            const ratingB = parseFloat(b.rating) || 0;
                            return ratingB - ratingA;
                        });
                    } else if (this.sortBy === 'reviews') {
                        filtered.sort((a, b) => {
                            const reviewsA = parseInt(a.review_count) || 0;
                            const reviewsB = parseInt(b.review_count) || 0;
                            return reviewsB - reviewsA;
                        });
                    }

                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    this.searchResults = filtered.slice(start, end);
                },
                clearFilters() {
                    this.sortBy = 'relevance';
                    this.minRating = 0;
                    this.currentPage = 1;
                    this.updateSearchResults();
                    this.showToast('ล้างตัวกรองแล้ว', 'success');
                },
                quickSearch(term) {
                    this.searchQuery = term;
                    if (!this.locationQuery) {
                        this.showToast('กรุณาระบุจังหวัดที่ต้องการ', 'warning');
                    } else {
                        this.performSearch();
                    }
                },
                previousPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.updateSearchResults();
                        setTimeout(() => {
                            document.getElementById('mainContainer').scrollTop = 0;
                        }, 0);
                    }
                },
                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                        this.updateSearchResults();
                        setTimeout(() => {
                            document.getElementById('mainContainer').scrollTop = 0;
                        }, 0);
                    }
                },
                goToPage(page) {
                    this.currentPage = page;
                    this.updateSearchResults();
                    setTimeout(() => {
                        document.getElementById('mainContainer').scrollTop = 0;
                    }, 0);
                },
                openCollectionsModal(place) {
                    this.collectionsModal.selectedPlace = place;
                    this.collectionsModal.show = true;
                },
                selectCollection(collection) {
                    const place = this.collectionsModal.selectedPlace;
                    if (!place) return;

                    const placeData = {
                        id: Math.random().toString(36).substr(2, 9),
                        title: place.title,
                        address: place.address,
                        thumbnail: place.thumbnail || this.defaultImage,
                        rating: place.rating,
                        type: place.type
                    };

                    if (!collection.places) {
                        collection.places = [];
                    }

                    const exists = collection.places.some(p => p.title === placeData.title);
                    if (!exists) {
                        collection.places.push(placeData);
                        this.saveCollectionsToStorage();
                        this.showToast(`เพิ่มเข้า "${collection.name}" แล้ว`, 'success');
                    } else {
                        this.showToast('สถานที่นี้อยู่ในการรวมกลุ่มแล้ว', 'warning');
                    }

                    this.collectionsModal.show = false;
                },
                createNewCollection() {
                    if (!this.newCollectionName.trim()) {
                        this.showToast('กรุณาระบุชื่อการรวมกลุ่ม', 'warning');
                        return;
                    }

                    const exists = this.collections.some(c => c.name === this.newCollectionName);
                    if (exists) {
                        this.showToast('มีการรวมกลุ่มนี้อยู่แล้ว', 'warning');
                        return;
                    }

                    const newCollection = {
                        id: Math.random().toString(36).substr(2, 9),
                        name: this.newCollectionName,
                        places: []
                    };

                    if (this.collectionsModal.selectedPlace) {
                        newCollection.places.push({
                            id: Math.random().toString(36).substr(2, 9),
                            title: this.collectionsModal.selectedPlace.title,
                            address: this.collectionsModal.selectedPlace.address,
                            thumbnail: this.collectionsModal.selectedPlace.thumbnail || this.defaultImage,
                            rating: this.collectionsModal.selectedPlace.rating,
                            type: this.collectionsModal.selectedPlace.type
                        });
                    }

                    this.collections.push(newCollection);
                    this.saveCollectionsToStorage();
                    this.newCollectionName = '';
                    this.showToast('สร้างการรวมกลุ่มแล้ว', 'success');
                    this.collectionsModal.show = false;
                },
                saveCollectionsToStorage() {
                    localStorage.setItem(CACHE_KEYS.COLLECTIONS, JSON.stringify(this.collections));
                },
                loadCollectionsFromStorage() {
                    const stored = localStorage.getItem(CACHE_KEYS.COLLECTIONS);
                    if (stored) {
                        try {
                            this.collections = JSON.parse(stored);
                        } catch (error) {
                            this.collections = [];
                        }
                    }
                },
                openNotesModal(place) {
                    this.notesModal.placeName = place.title;
                    this.notesModal.placeId = place.title;
                    this.notesModal.content = this.notes[place.title] || '';
                    this.notesModal.show = true;
                },
                saveNote() {
                    if (!this.notesModal.placeId) return;

                    this.notes[this.notesModal.placeId] = this.notesModal.content;
                    this.saveNotesToStorage();
                    this.notesModal.show = false;
                    this.showToast('บันทึกหมายเหตุแล้ว', 'success');
                },
                saveNotesToStorage() {
                    localStorage.setItem(CACHE_KEYS.NOTES, JSON.stringify(this.notes));
                },
                loadNotesFromStorage() {
                    const stored = localStorage.getItem(CACHE_KEYS.NOTES);
                    if (stored) {
                        try {
                            this.notes = JSON.parse(stored);
                        } catch (error) {
                            this.notes = {};
                        }
                    }
                },
                imageError(event) {
                    event.target.src = this.defaultImage;
                },
                toggleProfile() {
                    this.profileOpen = !this.profileOpen;
                },
                toggleMobileFav() {
                    this.mobileFavOpen = !this.mobileFavOpen;
                },
                handleClickOutside(e) {
                    if (this.$refs.profileDropdown && !this.$refs.profileDropdown.contains(e.target)) {
                        this.profileOpen = false;
                    }
                },
                goToDashboard() {
                    window.location.href = 'dashboard.html';
                },
                async logout() {
                    this.loading = true;
                    this.loadingText = 'กำลังออกจากระบบ...';
                    try {
                        const result = await firebaseService.logout();
                        if (result.success) {
                            CacheManager.clear();
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        this.showError('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการออกจากระบบ', error.message);
                        this.loading = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
